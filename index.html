// --- 修復版：自動 GPS 定位 + 行程地點天氣抓取 ---
async function updateWeather(fallbackLocation) {
    const weatherBox = document.getElementById('weather-box');
    
    // 取得天氣的內部函數
    const getWeatherData = async (params) => {
        try {
            const url = `https://api.openweathermap.org/data/2.5/weather?${params}&appid=${WEATHER_KEY}&units=metric&lang=zh_tw`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.cod === 200) {
                weatherBox.innerHTML = `
                    <img src="https://openweathermap.org/img/wn/${data.weather[0].icon}.png" width="30">
                    <b>${data.name}: ${Math.round(data.main.temp)}°C</b> 
                    <span>(體感 ${Math.round(data.main.feels_like)}°C)</span>`;
                return true;
            }
            return false;
        } catch (e) {
            console.error("天氣 API 呼叫失敗", e);
            return false;
        }
    };

    // 優先執行：手機 GPS 定位
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                console.log("GPS 定位成功:", lat, lon);
                await getWeatherData(`lat=${lat}&lon=${lon}`);
            },
            async (error) => {
                console.warn("GPS 定位失敗或被拒絕，切換至行程地點天氣", error);
                if (fallbackLocation) {
                    const city = fallbackLocation.split(/[ ,，、]/)[0].substring(0, 10);
                    await getWeatherData(`q=${encodeURIComponent(city)}`);
                } else {
                    weatherBox.innerText = "請開啟 GPS 或新增行程以顯示天氣";
                }
            },
            { timeout: 5000 } // 設定 5 秒超時
        );
    } else if (fallbackLocation) {
        // 手機不支援 GPS 時的備案
        const city = fallbackLocation.split(/[ ,，、]/)[0].substring(0, 10);
        await getWeatherData(`q=${encodeURIComponent(city)}`);
    }
}
