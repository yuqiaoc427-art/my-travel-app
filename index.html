import React, { useState, useEffect } from 'react';
import { TripSettings, Flight, Member } from '../types';
import { setDoc, doc } from 'firebase/firestore';
import { db } from '../services/firebase';
import BoardingPass from './BoardingPass';
import { Input } from './ui/Input';
import { Button } from './ui/Button';
import SnowEffect from './SnowEffect';

// 旅伴頭像選項 - 已更新為您提供的 8 張圖片
const AVATAR_OPTIONS = [
  { name: '頭像 1', url: 'image_5252f4.png' },
  { name: '頭像 2', url: 'image_525023.png' },
  { name: '頭像 3', url: 'image_525047.png' },
  { name: '頭像 4', url: 'image_525041.png' },
  { name: '頭像 5', url: 'image_525332.png' },
  { name: '頭像 6', url: 'image_525310.png' },
  { name: '頭像 7', url: 'image_52532b.png' },
  { name: '頭像 8', url: 'image_5252ee.png' }
];

interface HomeTabProps {
  settings: TripSettings;
  flights: Flight[];
  onReset: () => void;
}

const HomeTab: React.FC<HomeTabProps> = ({ settings, flights, onReset }) => {
  const [exchangeRate, setExchangeRate] = useState(0.22);
  const [jpy, setJpy] = useState('');
  const [twd, setTwd] = useState('');
  const [localSettings, setLocalSettings] = useState<TripSettings>(settings);
  const [isFlightModalOpen, setIsFlightModalOpen] = useState(false);

  useEffect(() => {
    setLocalSettings(settings);
  }, [settings]);

  useEffect(() => {
    fetch('https://open.er-api.com/v6/latest/JPY')
      .then(res => res.json())
      .then(data => setExchangeRate(data.rates.TWD))
      .catch(() => {});
  }, []);

  const saveSettings = async () => {
    await setDoc(doc(db, "settings", "currentTrip"), localSettings);
    alert("❄️ 北海道行程已同步");
  };

  const handleMemberChange = (index: number, field: keyof Member, value: string) => {
    const newMembers = [...localSettings.members];
    newMembers[index] = { ...newMembers[index], [field]: value };
    setLocalSettings({...localSettings, members: newMembers});
  };

  const addMember = () => {
    setLocalSettings({
      ...localSettings, 
      members: [...localSettings.members, { name: '', avatar: AVATAR_OPTIONS[0].url }]
    });
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-700 relative">
      <SnowEffect />
      
      {/* 航班資訊 */}
      <section className="space-y-4">
        <div className="flex justify-between items-center px-2">
          <h2 className="text-xs font-black text-slate-500 uppercase tracking-widest">我的機票</h2>
          <button onClick={() => setIsFlightModalOpen(true)} className="text-blue-600 text-xs font-bold transition-colors hover:text-blue-800">+ 新增</button>
        </div>
        <div className="flex gap-4 overflow-x-auto pb-2 no-scrollbar px-1">
          {flights.map(f => <div key={f.id} className="min-w-[280px] shrink-0"><BoardingPass flight={f} /></div>)}
          {flights.length === 0 && (
            <div className="w-full bg-white/50 border-2 border-dashed border-blue-100 rounded-[30px] p-6 text-center text-slate-300">
              尚無航班資訊
            </div>
          )}
        </div>
      </section>

      {/* 旅程設定 */}
      <section className="bg-white/80 backdrop-blur-md rounded-[40px] p-7 shadow-sm border border-white space-y-5">
        <h2 className="text-lg font-black text-slate-800 flex items-center gap-2">
          <i className="fas fa-snowflake text-blue-400"></i> 旅程設定
        </h2>
        <Input 
          label="旅行主題" 
          value={localSettings.tripName} 
          onChange={v => setLocalSettings({...localSettings, tripName: v})} 
        />
        
        <div className="space-y-3">
          <label className="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">旅伴與頭像</label>
          <div className="flex flex-col gap-3">
            {localSettings.members.map((m, i) => (
              <div key={i} className="flex items-center gap-3 bg-slate-50 p-2 rounded-3xl group transition-all hover:bg-slate-100">
                <div className="relative shrink-0">
                  <img src={m.avatar} className="w-12 h-12 rounded-full border-2 border-white shadow-sm bg-white p-0.5 object-cover" alt="Avatar" />
                  <select 
                    className="absolute inset-0 opacity-0 cursor-pointer"
                    value={m.avatar}
                    onChange={e => handleMemberChange(i, 'avatar', e.target.value)}
                  >
                    {AVATAR_OPTIONS.map(opt => (
                      <option key={opt.url} value={opt.url}>{opt.name}</option>
                    ))}
                  </select>
                </div>
                <input 
                  className="bg-transparent border-none outline-none font-bold text-slate-700 w-full text-sm"
                  value={m.name}
                  placeholder="旅伴名稱"
                  onChange={e => handleMemberChange(i, 'name', e.target.value)}
                />
                <button onClick={() => {
                   const nm = [...localSettings.members];
                   nm.splice(i, 1);
                   setLocalSettings({...localSettings, members: nm});
                }} className="text-slate-200 px-2 hover:text-rose-500 transition-colors"><i className="fas fa-times"></i></button>
              </div>
            ))}
            <button onClick={addMember} className="py-3 border-2 border-dashed border-slate-100 rounded-2xl text-slate-400 text-[10px] font-black uppercase hover:bg-slate-50 transition-colors">
              + 新增旅伴
            </button>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <Input type="date" label="出發日" value={localSettings.start} onChange={v => setLocalSettings({...localSettings, start: v})} />
          <Input type="date" label="回程日" value={localSettings.end} onChange={v => setLocalSettings({...localSettings, end: v})} />
        </div>
        <Button onClick={saveSettings} className="w-full">儲存設定</Button>
      </section>

      {/* 匯率換算 */}
      <section className="bg-white/80 backdrop-blur-md rounded-[40px] p-7 shadow-sm border border-white">
        <h2 className="text-lg font-black text-slate-800 flex items-center gap-2 mb-5">
          <i className="fas fa-coins text-amber-400"></i> 北海道匯率換算
        </h2>
        <div className="flex items-center justify-between gap-4">
          <div className="flex-1 bg-slate-50 p-4 rounded-[25px]">
            <span className="text-[10px] font-black text-slate-400 block mb-1">JPY</span>
            <input type="number" className="w-full bg-transparent border-none text-xl font-black text-slate-700 outline-none" value={jpy} onChange={e => {
              setJpy(e.target.value);
              const val = parseFloat(e.target.value);
              setTwd(isNaN(val) ? '' : (val * exchangeRate).toFixed(0));
            }} />
          </div>
          <i className="fas fa-exchange-alt text-slate-200"></i>
          <div className="flex-1 bg-slate-50 p-4 rounded-[25px]">
            <span className="text-[10px] font-black text-slate-400 block mb-1">TWD</span>
            <input type="number" className="w-full bg-transparent border-none text-xl font-black text-slate-700 outline-none" value={twd} onChange={e => {
              setTwd(e.target.value);
              const val = parseFloat(e.target.value);
              setJpy(isNaN(val) ? '' : (val / exchangeRate).toFixed(0));
            }} />
          </div>
        </div>
      </section>

      <Button variant="danger" className="w-full bg-white text-rose-500 border-none shadow-none font-bold py-3 transition-colors hover:bg-rose-50" onClick={onReset}>
        清除目前旅程
      </Button>

      {isFlightModalOpen && <FlightModal onClose={() => setIsFlightModalOpen(false)} />}
    </div>
  );
};

const FlightModal: React.FC<{ onClose: () => void }> = ({ onClose }) => {
  const [flight, setFlight] = useState({ air: '', no: '', from: '', fromT: '', to: '', toT: '', type: 'go' as 'go' | 'back' });
  const save = async () => {
    if (!flight.air || !flight.from || !flight.to) return alert("請填寫完整資訊");
    await setDoc(doc(db, "flights", flight.type), flight);
    onClose();
  };
  return (
    <div className="fixed inset-0 z-[100] bg-blue-900/40 flex items-center justify-center p-6 backdrop-blur-sm">
      <div className="bg-white rounded-[40px] w-full max-w-sm p-8 space-y-4 shadow-2xl animate-in zoom-in-95 duration-300">
        <h3 className="text-xl font-black">新增登機證</h3>
        <select className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none" value={flight.type} onChange={e => setFlight({...flight, type: e.target.value as any})}>
          <option value="go">去程航班</option><option value="back">回程航班</option>
        </select>
        <Input label="航空公司" value={flight.air} onChange={v => setFlight({...flight, air: v})} />
        <Input label="航班號碼" value={flight.no} onChange={v => setFlight({...flight, no: v})} />
        <div className="grid grid-cols-2 gap-2">
          <Input label="起點" value={flight.from} onChange={v => setFlight({...flight, from: v.toUpperCase()})} />
          <Input label="時間" type="time" value={flight.fromT} onChange={v => setFlight({...flight, fromT: v})} />
        </div>
        <div className="grid grid-cols-2 gap-2">
          <Input label="終點" value={flight.to} onChange={v => setFlight({...flight, to: v.toUpperCase()})} />
          <Input label="時間" type="time" value={flight.toT} onChange={v => setFlight({...flight, toT: v})} />
        </div>
        <div className="pt-4 flex gap-2">
          <Button variant="secondary" className="flex-1" onClick={onClose}>取消</Button>
          <Button className="flex-1 bg-blue-600" onClick={save}>儲存</Button>
        </div>
      </div>
    </div>
  );
};

export default HomeTab;
