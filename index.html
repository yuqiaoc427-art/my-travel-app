<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qiao æ—…éŠèªŒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root { --glass: rgba(255, 255, 255, 0.92); --blur: blur(20px); --accent: #1e3c72; --danger: #e74c3c; --success: #27ae60; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 100px; background: url('https://static.gltjp.com/glt/data/article/21000/20246/20230828_043453_d11a1481_w1920.webp') no-repeat center center fixed; background-size: cover; min-height: 100vh; color: #333; overflow-x: hidden; }
        
        .tab-content { display: none; padding: 0 10px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); padding: 40px 20px 10px; }
        #weather-box { background: rgba(0,0,0,0.35); color: white; border-radius: 15px; padding: 8px 12px; margin: 10px auto; width: fit-content; display: flex; align-items: center; gap: 6px; font-size: 13px; backdrop-filter: blur(5px); min-height: 38px; }

        .boarding-pass { background: #fff; border-radius: 15px; margin: 10px 5px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border-left: 5px solid var(--accent); max-width: 95%; margin-left: auto; margin-right: auto; }
        .ticket-top { background: var(--accent); color: white; padding: 8px 12px; display: flex; justify-content: space-between; font-size: 10px; font-weight: bold; }
        .ticket-mid { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .airport-code { font-size: 24px; font-weight: 900; color: var(--accent); margin: 0; }

        .date-container { display: flex; overflow-x: auto; padding: 15px 5px; gap: 10px; scrollbar-width: none; }
        .date-item { min-width: 60px; height: 85px; background: var(--glass); border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); flex-shrink: 0; }
        .date-item.active { background: var(--accent); color: white; border: none; box-shadow: 0 5px 15px rgba(30,60,114,0.3); }

        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 22px; margin: 10px 0; padding: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
        .itinerary-card { display: flex; align-items: center; }
        .delete-btn-tl { position: absolute; top: 8px; left: 8px; color: var(--danger); font-size: 16px; cursor: pointer; z-index: 10; opacity: 0.7; }

        .nav-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.98); height: 55px; border-radius: 28px; display: flex; box-shadow: 0 8px 25px rgba(0,0,0,0.2); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; text-decoration: none; font-size: 10px; }
        .nav-item.active { color: var(--accent); font-weight: 900; }

        .fab { position: fixed; bottom: 85px; right: 25px; width: 50px; height: 50px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 900; border: none; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 12px; font-size: 15px; box-sizing: border-box; }
        
        .settle-card { background: #f8f9fa; border-left: 5px solid var(--success); padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
        .expense-detail-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; cursor: pointer; }
        .convert-hint { font-size: 11px; color: var(--accent); margin-top: -5px; margin-bottom: 10px; display: block; font-weight: bold; }
        .preview-box { width: 100%; max-height: 150px; border-radius: 12px; object-fit: cover; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <div class="header"><h1 id="dynamic-trip-name">æ—…éŠèªŒ</h1></div>

    <div id="tab-home" class="tab-content active">
        <div id="flight-display-area"></div>
        <div class="card">
            <strong>æ—…ç¨‹åŸºæœ¬è¨­å®š</strong>
            <input type="text" id="input-trip-name" placeholder="æ—…è¡Œåç¨±">
            <div id="members-list-container"></div>
            <button onclick="addMemberRow()" style="background:var(--accent); color:white; border:none; padding:8px; border-radius:8px; width:100%; margin: 10px 0;">+ æ–°å¢æˆå“¡</button>
            <div style="display:flex; gap:10px;">
                <input type="date" id="input-start-date"><input type="date" id="input-end-date">
            </div>
            <button onclick="saveBaseSettings()" style="width:100%; padding:14px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:bold; margin-top:10px;">å„²å­˜è¨­å®š</button>
        </div>
        <div class="card">
            <strong>ğŸ’¹ åŒ¯ç‡æ›ç®—</strong>
            <input type="number" id="input-jpy" placeholder="JPY" oninput="convertCurrency('JPY')">
            <input type="number" id="input-twd" placeholder="TWD" oninput="convertCurrency('TWD')">
        </div>
    </div>

    <div id="tab-plan" class="tab-content">
        <div id="weather-box">æ­£åœ¨è«‹æ±‚ GPS å®šä½...</div>
        <div class="date-container" id="date-scroll"></div>
        <div id="itinerary-list"></div>
        <button class="fab" onclick="openModal('modal-itinerary')"><i class="fas fa-plus"></i></button>
    </div>

    <div id="tab-split" class="tab-content">
        <div id="settle-suggestions" class="settle-card">æ­£åœ¨è¨ˆç®—...</div>
        <div class="card" style="text-align:center;">
            <p style="margin:0; color:#666;">æ—…ç¨‹ç¸½æ”¯å‡º</p>
            <h1 id="total-val">$0</h1>
            <div id="personal-list"></div>
        </div>
        <div class="card">
            <strong>èŠ±è²»æ˜ç´° (é»æ“Šå¯ç·¨è¼¯)</strong>
            <div id="expense-detail-list" style="margin-top:10px;"></div>
        </div>
        <button class="fab" onclick="window.openPayment()"><i class="fas fa-plus"></i></button>
    </div>

    <div id="modal-payment" class="modal-overlay"><div class="modal-content">
        <h3 id="payment-modal-title">ğŸ’° æ–°å¢æ”¯å‡º</h3>
        <input type="hidden" id="edit-expense-id">
        <input type="text" id="pay-name" placeholder="é …ç›®åç¨± (å¦‚: æ™šé¤)">
        
        <div style="display:flex; gap:10px; align-items:center;">
            <select id="pay-currency" style="flex:0.4;" onchange="updateConvertHint()">
                <option value="TWD">TWD å°å¹£</option>
                <option value="JPY">JPY æ—¥åœ“</option>
            </select>
            <input type="number" id="pay-amount" placeholder="é‡‘é¡" style="flex:1;" oninput="updateConvertHint()">
        </div>
        <span id="convert-hint" class="convert-hint"></span>

        <p style="font-size:12px; margin:0;">èª°å…ˆå¢Šä»˜ï¼š</p>
        <select id="pay-payer"></select>
        
        <p style="font-size:12px; margin:10px 0 0;">åˆ†æ”¤æˆå“¡ï¼š</p>
        <div id="pay-split-list"></div>

        <p style="font-size:12px; margin:10px 0 0;">å‚™è¨»èªªæ˜ï¼š</p>
        <textarea id="pay-note" rows="2" placeholder="å‚™è¨»æˆ–æ˜¯è©³ç´°èªªæ˜..."></textarea>

        <p style="font-size:12px; margin:10px 0 0;">é™„ä»¶/åœ–ç‰‡ï¼š</p>
        <input type="file" id="pay-file" accept="image/*" onchange="previewExpenseImage(this)">
        <img id="expense-img-preview" class="preview-box">

        <button onclick="saveExpense()" id="save-expense-btn" style="width:100%; background:var(--success); color:white; padding:12px; border:none; border-radius:12px; margin-top:15px;">å„²å­˜å¸³ç›®</button>
        <button id="del-expense-btn" onclick="deleteExpenseReal()" style="width:100%; background:var(--danger); color:white; padding:12px; border:none; border-radius:12px; margin-top:5px; display:none;">åˆªé™¤æ­¤ç­†</button>
        <button onclick="closeModal()" style="width:100%; background:#eee; margin-top:5px; border:none; padding:10px; border-radius:12px;">å–æ¶ˆ</button>
    </div></div>

    <div class="nav-bar">
        <a href="javascript:void(0)" class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home"></i><span>é¦–é </span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-plan', this)"><i class="fas fa-calendar-alt"></i><span>è¡Œç¨‹</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-split', this)"><i class="fas fa-coins"></i><span>åˆ†å¸³</span></a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, updateDoc, getDoc, getDocs, where, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCcXPvCma5TilSjZfAGYJg8n8ZfAAsqNtE", authDomain: "my-travel-app-b029c.firebaseapp.com", projectId: "my-travel-app-b029c", storageBucket: "my-travel-app-b029c.appspot.com", messagingSenderId: "898590101576", appId: "1:898590101576:web:7c1916bb7ebbada144487d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentMembers = [], exchangeRate = 0.22;

        // --- åŒ¯ç‡èˆ‡æ›ç®—é‚è¼¯ ---
        window.updateConvertHint = () => {
            const amount = Number(document.getElementById('pay-amount').value);
            const curr = document.getElementById('pay-currency').value;
            const hint = document.getElementById('convert-hint');
            if(!amount) { hint.innerText = ""; return; }
            if(curr === 'TWD') {
                hint.innerText = `â‰ˆ JPY ${(amount / exchangeRate).toFixed(0)}`;
            } else {
                hint.innerText = `â‰ˆ TWD ${(amount * exchangeRate).toFixed(0)}`;
            }
        };

        // --- æª”æ¡ˆé è¦½ ---
        window.previewExpenseImage = (input) => {
            const preview = document.getElementById('expense-img-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // --- åˆ†å¸³åŠŸèƒ½ï¼šé–‹å•Ÿå½ˆçª— (æ”¯æ´ç·¨è¼¯) ---
        window.openPayment = async (id = null) => {
            // é‡è¨­ UI
            document.getElementById('edit-expense-id').value = id || "";
            document.getElementById('pay-name').value = "";
            document.getElementById('pay-amount').value = "";
            document.getElementById('pay-note').value = "";
            document.getElementById('pay-file').value = "";
            document.getElementById('expense-img-preview').style.display = "none";
            document.getElementById('del-expense-btn').style.display = id ? "block" : "none";
            document.getElementById('payment-modal-title').innerText = id ? "ğŸ“ ç·¨è¼¯æ”¯å‡º" : "ğŸ’° æ–°å¢æ”¯å‡º";

            // è¼‰å…¥æˆå“¡æ¸…å–®
            let opt = '', chk = '';
            currentMembers.forEach(m => {
                opt += `<option value="${m.name}">${m.name}</option>`;
                chk += `<label style="display:block;margin:5px 0;"><input type="checkbox" class="split-cb" value="${m.name}" checked> ${m.name}</label>`;
            });
            document.getElementById('pay-payer').innerHTML = opt;
            document.getElementById('pay-split-list').innerHTML = chk;

            // å¦‚æœæ˜¯ç·¨è¼¯ï¼Œè¼‰å…¥èˆŠè³‡æ–™
            if(id) {
                const ds = await getDoc(doc(db, "expenses", id));
                const d = ds.data();
                document.getElementById('pay-name').value = d.name;
                document.getElementById('pay-amount').value = d.rawAmount || d.amount;
                document.getElementById('pay-currency').value = d.currency || 'TWD';
                document.getElementById('pay-payer').value = d.payer;
                document.getElementById('pay-note').value = d.note || "";
                if(d.img) { 
                    const p = document.getElementById('expense-img-preview');
                    p.src = d.img; p.style.display = 'block';
                }
                updateConvertHint();
            }
            openModal('modal-payment');
        };

        // --- å„²å­˜æ”¯å‡º (æ”¯æ´ TWD/JPY è‡ªå‹•è½‰æ›èˆ‡åœ–ç‰‡) ---
        window.saveExpense = async () => {
            const id = document.getElementById('edit-expense-id').value;
            const name = document.getElementById('pay-name').value;
            const rawAmount = Number(document.getElementById('pay-amount').value);
            const currency = document.getElementById('pay-currency').value;
            const payer = document.getElementById('pay-payer').value;
            const splitTo = [...document.querySelectorAll('.split-cb:checked')].map(c => c.value);
            const note = document.getElementById('pay-note').value;
            const img = document.getElementById('expense-img-preview').src || "";

            if(!name || !rawAmount) return alert("è«‹å¡«å¯«åç¨±èˆ‡é‡‘é¡");

            // çµ±ä¸€è½‰æ›æˆ TWD å„²å­˜æ–¼ amount æ¬„ä½ï¼Œæ–¹ä¾¿è¨ˆç®—ç¸½é¡
            const amount = (currency === 'JPY') ? rawAmount * exchangeRate : rawAmount;

            const data = { name, rawAmount, amount, currency, payer, splitTo, note, img, createdAt: serverTimestamp() };
            
            if(id) await updateDoc(doc(db, "expenses", id), data);
            else await addDoc(collection(db, "expenses"), data);
            
            closeModal();
        };

        window.deleteExpenseReal = async () => {
            const id = document.getElementById('edit-expense-id').value;
            if(id && confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†å¸³ç›®ï¼Ÿ")) { await deleteDoc(doc(db, "expenses", id)); closeModal(); }
        };

        // --- ç›£è½åˆ†å¸³æ˜ç´° ---
        onSnapshot(query(collection(db, "expenses"), orderBy("createdAt", "desc")), (snap) => {
            let total = 0, balances = {}, html = '';
            currentMembers.forEach(m => balances[m.name] = 0);

            snap.forEach(ds => {
                const d = ds.data(), id = ds.id;
                total += d.amount;
                // åˆ†å¸³è¨ˆç®—
                if(balances.hasOwnProperty(d.payer)) balances[d.payer] += d.amount;
                const per = d.amount / d.splitTo.length;
                d.splitTo.forEach(m => { if(balances.hasOwnProperty(m)) balances[m] -= per; });

                html += `
                <div class="expense-detail-item" onclick="window.openPayment('${id}')">
                    <div style="flex:1;">
                        <b>${d.name}</b><br>
                        <small style="color:#888;">${d.payer} å¢Šä»˜ (${d.currency || 'TWD'} ${d.rawAmount})</small>
                    </div>
                    <div style="text-align:right;">
                        <b style="color:var(--accent);">$${Math.round(d.amount).toLocaleString()}</b><br>
                        <small style="font-size:9px; color:#999;">${d.img ? 'ğŸ–¼ï¸ å·²é™„åœ–' : ''}</small>
                    </div>
                </div>`;
            });
            document.getElementById('total-val').innerText = "$" + Math.round(total).toLocaleString();
            document.getElementById('expense-detail-list').innerHTML = html;
            updateSettleUI(balances);
        });

        function updateSettleUI(balances) {
            let listHtml = '', debtors = [], creditors = [];
            Object.keys(balances).forEach(m => {
                const b = Math.round(balances[m]);
                listHtml += `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;font-size:14px;"><span>${m}</span><b style="color:${b>=0?'var(--success)':'var(--danger)'}">${b>=0?'+':''}${b.toLocaleString()}</b></div>`;
                if(b < -1) debtors.push({n:m, a:-b}); else if(b > 1) creditors.push({n:m, a:b});
            });
            document.getElementById('personal-list').innerHTML = listHtml;

            let sug = "<strong>ğŸ’¡ çµç®—å»ºè­°ï¼š</strong><br>", i=0, j=0;
            while(i<debtors.length && j<creditors.length) {
                let p = Math.min(debtors[i].a, creditors[j].a);
                sug += `${debtors[i].n} â¡ï¸ çµ¦ ${creditors[j].n} <b>$${Math.round(p)}</b><br>`;
                debtors[i].a -= p; creditors[j].a -= p;
                if(debtors[i].a < 1) i++; if(creditors[j].a < 1) j++;
            }
            document.getElementById('settle-suggestions').innerHTML = (debtors.length===0) ? "âœ… å¸³ç›®å·²çµæ¸…" : sug;
        }

        // --- å…¶é¤˜åŸæœ¬åŠŸèƒ½åˆå§‹åŒ– (ç•¥ï¼Œä¿æŒä¸è®Š) ---
        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        };
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');

        // å•Ÿå‹•ç›£è½èˆ‡åŒ¯ç‡
        onSnapshot(doc(db, "settings", "currentTrip"), (snap) => {
            if(snap.exists()){
                const d = snap.data();
                currentMembers = d.members || [];
                // é€™è£¡æœƒè§¸ç™¼å¾ŒçºŒçš„ onSnapshot expenses
            }
        });
        
        // åŒ¯ç‡ç²å– logic åŒå‰...
    </script>
</body>
</html>
