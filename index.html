<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qiao æ—…éŠèªŒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.82); 
            --blur: blur(15px); 
            --accent: #2c3e50; 
            --flight-bg: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; padding-bottom: 120px;
            background: url('https://static.gltjp.com/glt/data/article/21000/20246/20230828_043453_d11a1481_w1920.webp') no-repeat center center fixed;
            background-size: cover; min-height: 100vh;
            font-size: 16px; /* çµ±ä¸€å­—é«”å¤§å°åŸºæº– */
        }

        .card { 
            background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            padding: 20px; border-radius: 24px; margin: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.4);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; color: white; text-shadow: 0 2px 12px rgba(0,0,0,0.5); padding: 45px 20px 10px; }
        .header h1 { margin: 0; font-size: 28px; font-weight: 800; }

        /* æ—¥æœŸåˆ‡æ›æŒ‰éˆ•å€ */
        .date-selector {
            display: flex; overflow-x: auto; padding: 10px 15px; gap: 10px;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .date-selector::-webkit-scrollbar { display: none; }
        .date-btn {
            flex: 0 0 70px; height: 75px; background: var(--glass); border-radius: 18px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.4); cursor: pointer; transition: 0.3s;
        }
        .date-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .date-btn .d-num { font-size: 18px; font-weight: bold; }
        .date-btn .d-week { font-size: 12px; opacity: 0.8; margin-top: 2px; }

        /* è¡Œç¨‹é …ç›®èˆ‡äº¤é€šæ™‚é–“ */
        .trip-item { position: relative; padding: 15px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .trip-info b { font-size: 18px; color: var(--accent); }
        .transport-divider {
            display: flex; align-items: center; justify-content: center;
            padding: 10px 0; font-size: 14px; color: #555; opacity: 0.8;
        }
        .transport-divider i { margin-right: 8px; font-size: 16px; }

        /* å…¶é¤˜æ¨£å¼ä¿æŒä¸€è‡´ */
        .flight-card { background: var(--flight-bg); border-radius: 20px; padding: 18px; margin: 15px; color: white; }
        .fab { position: fixed; bottom: 110px; right: 25px; width: 60px; height: 60px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 999; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .nav-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.9); height: 75px; border-radius: 37px; display: flex; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #95a5a6; font-size: 12px; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        input, select { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 12px; background: rgba(255,255,255,0.8); font-size: 16px; }
    </style>
</head>
<body>

    <div class="header"><h1>Qiao æ—…éŠèªŒ</h1></div>

    <div id="tab-home" class="tab-content active">
        <div id="flight-display"></div>
        <div class="card">
            <strong>âš™ï¸ æ—…ç¨‹åŸºç¤è¨­å®š</strong>
            <input type="text" id="setup-trip-name" placeholder="æ—…è¡Œåç¨±">
            <input type="text" id="setup-members" placeholder="æˆå“¡ (ç”¨é€—è™Ÿéš”é–‹)">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><small>é–‹å§‹æ—¥æœŸ</small><input type="date" id="setup-start"></div>
                <div style="flex:1;"><small>çµæŸæ—¥æœŸ</small><input type="date" id="setup-end"></div>
            </div>
            <button onclick="saveSettings()" style="width:100%; padding:15px; background:var(--accent); color:white; border-radius:12px; border:none; margin-top:10px; font-size:16px;">å„²å­˜ä¸¦åŒæ­¥æ—¥æœŸ</button>
        </div>
    </div>

    <div id="tab-plan" class="tab-content">
        <div class="date-selector" id="date-buttons"></div>
        <div class="card" id="trip-list-container">
            <div id="trip-list"></div>
        </div>
        <div class="fab" onclick="openModal()"><i class="fas fa-plus"></i></div>
    </div>

    <div id="tab-files" class="tab-content">
        <div class="card">
            <strong>ğŸ“ é›²ç«¯é™„ä»¶</strong>
            <input type="text" id="link-name" placeholder="åç¨±"><input type="text" id="link-url" placeholder="é€£çµ">
            <button onclick="saveLink()" style="width:100%; padding:15px; background:var(--accent); color:white; border-radius:12px; border:none;">æ–°å¢</button>
        </div>
        <div id="link-list"></div>
    </div>

    <div id="tab-split" class="tab-content">
        <div class="card" style="text-align:center;"><p>ç¸½æ”¯å‡º</p><h1 id="total-val" style="font-size:36px; color:var(--accent);">$0</h1></div>
        <div class="card"><strong>æ¸…ç®—å»ºè­°</strong><div id="settlement-list"></div></div>
        <div class="card"><strong>å€‹äººæ˜ç´°</strong><div id="personal-list"></div></div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="card" style="width:90%; max-width:400px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><strong>ç·¨è¼¯è¡Œç¨‹</strong><i class="fas fa-times" onclick="closeModal()"></i></div>
            <input type="date" id="date">
            <div style="display:flex; gap:10px;"><input type="time" id="start-time"><input type="time" id="end-time"></div>
            <input type="text" id="activity" placeholder="è¡Œç¨‹åç¨±">
            <input type="number" id="cost" placeholder="èŠ±è²»é‡‘é¡">
            <select id="payer-select"></select>
            <div id="member-selection-area" style="margin-top:10px;"></div>
            <button onclick="saveTrip()" style="width:100%; padding:15px; background:var(--accent); color:white; border-radius:12px; border:none; margin-top:15px;">å„²å­˜</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home"></i><span>é¦–é </span></div>
        <div class="nav-item" onclick="switchTab('tab-plan', this)"><i class="fas fa-calendar-alt"></i><span>è¡Œç¨‹</span></div>
        <div class="nav-item" onclick="switchTab('tab-files', this)"><i class="fas fa-paperclip"></i><span>é™„ä»¶</span></div>
        <div class="nav-item" onclick="switchTab('tab-split', this)"><i class="fas fa-coins"></i><span>åˆ†å¸³</span></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcXPvCma5TilSjZfAGYJg8n8ZfAAsqNtE",
            authDomain: "my-travel-app-b029c.firebaseapp.com",
            projectId: "my-travel-app-b029c",
            storageBucket: "my-travel-app-b029c.appspot.com",
            messagingSenderId: "898590101576",
            appId: "1:898590101576:web:7c1916bb7ebbada144487d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentMembers = [];
        let selectedDate = "";
        let tripDates = [];

        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        };

        window.openModal = () => { 
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('date').value = selectedDate;
        };
        window.closeModal = () => { document.getElementById('modal').style.display = 'none'; };

        window.saveSettings = async () => {
            const start = document.getElementById('setup-start').value;
            const end = document.getElementById('setup-end').value;
            const members = document.getElementById('setup-members').value.split(',').map(m => m.trim());
            await setDoc(doc(db, "settings", "currentTrip"), { 
                tripName: document.getElementById('setup-trip-name').value, 
                members, start, end 
            });
            alert("æ—¥æœŸèˆ‡è¨­å®šå·²åŒæ­¥ï¼");
        };

        // äº¤é€šæ™‚é–“è¨ˆç®— (ç°¡å–®æ¨¡æ“¬ï¼šå…©è¡Œç¨‹é–“éš”å³ç‚ºäº¤é€šæ™‚é–“)
        function getTravelTime(prevEnd, nextStart) {
            if (!prevEnd || !nextStart) return "";
            const s = nextStart.split(':').map(Number);
            const e = prevEnd.split(':').map(Number);
            let diff = (s[0] * 60 + s[1]) - (e[0] * 60 + e[1]);
            if (diff <= 0) return "";
            return `${Math.floor(diff/60)}h ${diff%60}m`;
        }

        onSnapshot(doc(db, "settings", "currentTrip"), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentMembers = data.members || [];
                document.getElementById('setup-trip-name').value = data.tripName || "";
                document.getElementById('setup-members').value = currentMembers.join(",");
                document.getElementById('setup-start').value = data.start || "";
                document.getElementById('setup-end').value = data.end || "";
                
                // ç”¢ç”Ÿæ—¥æœŸæŒ‰éˆ•
                if(data.start && data.end) {
                    let start = new Date(data.start);
                    let end = new Date(data.end);
                    let html = '';
                    const weekDays = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
                    while(start <= end) {
                        let dStr = start.toISOString().split('T')[0];
                        let active = selectedDate === dStr ? 'active' : '';
                        if(!selectedDate) { selectedDate = dStr; active = 'active'; }
                        html += `<div class="date-btn ${active}" onclick="filterDate('${dStr}')">
                            <span class="d-num">${start.getDate()}</span>
                            <span class="d-week">${weekDays[start.getDay()]}</span>
                        </div>`;
                        start.setDate(start.getDate() + 1);
                    }
                    document.getElementById('date-buttons').innerHTML = html;
                }

                // æ›´æ–°ä»˜æ¬¾äººé¸å–®
                let sHtml = '<option value="">-- é¸æ“‡ä»˜æ¬¾äºº --</option>';
                let mHtml = '';
                currentMembers.forEach(m => {
                    sHtml += `<option value="${m}">${m}</option>`;
                    mHtml += `<div class="member-chip" onclick="this.classList.toggle('selected')" style="padding:8px 12px; border-radius:15px; background:#eee; display:inline-block; margin:4px; font-size:14px; cursor:pointer;">${m}</div>`;
                });
                document.getElementById('payer-select').innerHTML = sHtml;
                document.getElementById('member-selection-area').innerHTML = mHtml;
            }
        });

        window.filterDate = (date) => {
            selectedDate = date;
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderTrips();
        };

        const q = query(collection(db, "trips"), orderBy("date", "asc"), orderBy("startTime", "asc"));
        let allTrips = [];
        onSnapshot(q, (snapshot) => {
            allTrips = [];
            snapshot.forEach(doc => allTrips.push({id: doc.id, ...doc.data()}));
            renderTrips();
        });

        function renderTrips() {
            let html = '';
            const dayTrips = allTrips.filter(t => t.date === selectedDate);
            dayTrips.forEach((t, index) => {
                // é¡¯ç¤ºè¡Œç¨‹
                html += `<div class="trip-item">
                    <small>${t.startTime} - ${t.endTime || ''}</small><br>
                    <b>${t.activity}</b>
                    ${t.cost > 0 ? `<div style="font-size:14px; color:#666;">$${t.cost} (${t.payer}ä»˜)</div>` : ''}
                </div>`;
                
                // é¡¯ç¤ºäº¤é€šæ™‚é–“
                if(index < dayTrips.length - 1) {
                    const travel = getTravelTime(t.endTime, dayTrips[index+1].startTime);
                    if(travel) {
                        html += `<div class="transport-divider">
                            <i class="fas fa-car"></i> <span>è»Šç¨‹ç´„ ${travel}</span>
                        </div>`;
                    }
                }
            });
            document.getElementById('trip-list').innerHTML = html || '<p style="text-align:center; opacity:0.5;">ä»Šæ—¥æš«ç„¡è¡Œç¨‹</p>';
        }

        // å…¶é¤˜ saveTrip, saveLink é‚è¼¯ä¿æŒä¸€è‡´...
        window.saveTrip = async () => {
            const data = {
                date: document.getElementById('date').value,
                startTime: document.getElementById('start-time').value,
                endTime: document.getElementById('end-time').value,
                activity: document.getElementById('activity').value,
                cost: Number(document.getElementById('cost').value || 0),
                payer: document.getElementById('payer-select').value,
                members: Array.from(document.querySelectorAll('#member-selection-area .selected')).map(el => el.innerText),
                updatedAt: new Date()
            };
            await addDoc(collection(db, "trips"), data);
            closeModal();
        };
    </script>
</body>
</html>
