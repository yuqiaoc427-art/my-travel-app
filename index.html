<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qiao æ—…éŠèªŒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.85); 
            --blur: blur(15px); 
            --accent: #1e3c72;
            --ticket-bg: #ffffff;
        }
        
        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; padding-bottom: 110px;
            background: url('https://static.gltjp.com/glt/data/article/21000/20246/20230828_043453_d11a1481_w1920.webp') no-repeat center center fixed;
            background-size: cover; min-height: 100vh;
        }

        /* é ‚éƒ¨æ¨™é¡Œ */
        .header { text-align: center; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); padding: 30px 20px 10px; }
        .header h1 { margin: 0; font-size: 26px; letter-spacing: 2px; }

        /* Boarding Pass æ¨£å¼ */
        .boarding-pass {
            background: var(--ticket-bg); border-radius: 16px; margin: 10px 15px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); overflow: hidden; position: relative;
        }
        .ticket-top { background: var(--accent); color: white; padding: 8px 15px; font-size: 11px; display: flex; justify-content: space-between; font-weight: bold; }
        .ticket-body { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .city-code { font-size: 28px; font-weight: 800; color: var(--accent); margin: 0; }
        .ticket-divider { border-top: 2px dashed #eee; margin: 0 15px; height: 1px; position: relative; }
        .ticket-footer { background: #fdfdfd; padding: 10px 15px; display: grid; grid-template-columns: 1fr 1fr; font-size: 11px; }

        /* æ—¥æœŸåˆ‡æ›å™¨ */
        .date-scroller { display: flex; overflow-x: auto; padding: 10px 15px; gap: 10px; scrollbar-width: none; }
        .date-btn { 
            flex: 0 0 65px; background: var(--glass); backdrop-filter: var(--blur);
            padding: 10px 0; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer; transition: 0.3s;
        }
        .date-btn.active { background: var(--accent); color: white; }
        .date-btn span { display: block; font-size: 14px; font-weight: bold; }
        .date-btn small { font-size: 11px; opacity: 0.8; }

        /* è¡Œç¨‹æµ®çª— */
        .trip-card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 20px; margin: 10px 15px; padding: 15px; position: relative; }
        .trip-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .trip-content { flex: 1; }
        .trip-actions { display: flex; flex-direction: column; gap: 8px; margin-left: 10px; }
        .btn-mini { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; border: none; cursor: pointer; color: white; width: 60px; }
        .btn-edit { background: #34495e; }
        .btn-cash { background: #27ae60; }
        
        /* é€šå‹¤æ™‚é–“ */
        .commute-info { text-align: center; padding: 5px 0; font-size: 12px; color: #555; }

        /* åº•éƒ¨æŒ‰éˆ• */
        .fab { 
            position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px;
            background: var(--accent); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999;
        }

        /* å°è¦½åˆ— */
        .nav-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(255,255,255,0.9); height: 70px; border-radius: 35px; display: flex; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #bbb; }
        .nav-item.active { color: var(--accent); font-weight: bold; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; border-radius: 20px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

    <div class="header"><h1 id="top-title">æ—…éŠèªŒ</h1></div>

    <div id="tab-home" class="tab-content active">
        <div id="flight-display-area"></div>
        <div class="card" style="margin-top:20px;">
            <strong>âš™ï¸ æ—…ç¨‹è¨­å®š</strong>
            <input type="text" id="setup-trip-name" placeholder="è¼¸å…¥è¡Œç¨‹åç¨±">
            <input type="text" id="setup-members" placeholder="æˆå“¡ (ç”¨é€—è™Ÿéš”é–‹)">
            <button onclick="saveSettings()">å„²å­˜æ—…ç¨‹</button>
        </div>
        <div class="fab" onclick="showModal('modal-flight')"><i class="fas fa-plus"></i></div>
    </div>

    <div id="tab-plan" class="tab-content">
        <div class="header"><h1>æ¯æ—¥è¡Œç¨‹</h1></div>
        <div class="date-scroller" id="date-buttons"></div>
        <div id="weather-area" style="text-align:center; color:white; padding:5px;"></div>
        <div id="trip-items-area"></div>
        <div class="fab" onclick="showModal('modal-trip')"><i class="fas fa-plus"></i></div>
    </div>

    <div id="tab-split" class="tab-content"><div class="card" id="personal-list"></div></div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home"></i><span>é¦–é </span></div>
        <div class="nav-item" onclick="switchTab('tab-plan', this)"><i class="fas fa-calendar-alt"></i><span>è¡Œç¨‹</span></div>
        <div class="nav-item" onclick="switchTab('tab-split', this)"><i class="fas fa-coins"></i><span>åˆ†å¸³</span></div>
    </div>

    <div id="modal-flight" class="modal">
        <div class="modal-content">
            <h3>è¼¸å…¥èˆªç­è³‡è¨Š</h3>
            <input type="text" id="fl-air" placeholder="èˆªç©ºå…¬å¸">
            <input type="text" id="fl-no" placeholder="èˆªç­è™Ÿç¢¼">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <input type="text" id="fl-start" placeholder="èµ·é£›æ©Ÿå ´ (TPE)"><input type="time" id="fl-start-t">
                <input type="text" id="fl-end" placeholder="æŠµé”æ©Ÿå ´ (NRT)"><input type="time" id="fl-end-t">
            </div>
            <select id="fl-type"><option value="go">å»ç¨‹</option><option value="back">å›ç¨‹</option></select>
            <button onclick="saveFlight()">å„²å­˜èˆªç­</button>
            <button onclick="closeModal()" style="background:#ccc;">é—œé–‰</button>
        </div>
    </div>

    <div id="modal-trip" class="modal">
        <div class="modal-content">
            <h3 id="trip-modal-title">ç·¨è¼¯è¡Œç¨‹è¨ˆç•«</h3>
            <input type="hidden" id="edit-trip-id">
            <input type="date" id="trip-date">
            <input type="text" id="trip-place" placeholder="åœ°é»åç¨±">
            <div style="display:flex; gap:5px;">
                <input type="time" id="trip-start"><input type="time" id="trip-end">
            </div>
            <button onclick="saveTrip()">å„²å­˜è¡Œç¨‹</button>
            <button onclick="closeModal()" style="background:#ccc;">é—œé–‰</button>
        </div>
    </div>

    <div id="modal-cash" class="modal">
        <div class="modal-content">
            <h3>è¡Œç¨‹è¨˜å¸³</h3>
            <input type="hidden" id="cash-trip-id">
            <input type="number" id="cash-amount" placeholder="é‡‘é¡">
            <select id="cash-payer"></select>
            <div id="cash-members"></div>
            <button onclick="saveCash()">ç¢ºèªå„²å­˜</button>
            <button onclick="closeModal()" style="background:#ccc;">é—œé–‰</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, updateDoc, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcXPvCma5TilSjZfAGYJg8n8ZfAAsqNtE",
            authDomain: "my-travel-app-b029c.firebaseapp.com",
            projectId: "my-travel-app-b029c",
            storageBucket: "my-travel-app-b029c.appspot.com",
            messagingSenderId: "898590101576",
            appId: "1:898590101576:web:7c1916bb7ebbada144487d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentTripName = "";
        let members = [];
        let selectedDate = "";

        // å·¥å…·å‡½æ•¸
        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        };
        window.showModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');

        // 1. é¦–é èˆ‡è¨­å®š
        window.saveSettings = async () => {
            const name = document.getElementById('setup-trip-name').value;
            const mems = document.getElementById('setup-members').value.split(',').map(m => m.trim());
            await setDoc(doc(db, "settings", "currentTrip"), { tripName: name, members: mems });
            alert("æ—…ç¨‹å·²è¨­å®š");
        };

        onSnapshot(doc(db, "settings", "currentTrip"), (ds) => {
            if (ds.exists()) {
                const d = ds.data();
                currentTripName = d.tripName;
                members = d.members;
                document.getElementById('top-title').innerText = currentTripName || "æ—…éŠèªŒ";
                // æ›´æ–°è¨˜å¸³ä»˜æ¬¾äººé¸é …
                const payerSelect = document.getElementById('cash-payer');
                payerSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            }
        });

        // 2. èˆªç­é‚è¼¯
        window.saveFlight = async () => {
            const data = {
                air: document.getElementById('fl-air').value,
                no: document.getElementById('fl-no').value,
                start: document.getElementById('fl-start').value,
                startT: document.getElementById('fl-start-t').value,
                end: document.getElementById('fl-end').value,
                endT: document.getElementById('fl-end-t').value,
                type: document.getElementById('fl-type').value,
                createdAt: new Date()
            };
            await addDoc(collection(db, "flights"), data);
            closeModal();
        };

        onSnapshot(query(collection(db, "flights"), orderBy("createdAt", "desc")), (snap) => {
            let html = '';
            snap.forEach(docSnap => {
                const f = docSnap.data();
                html += `
                <div class="boarding-pass">
                    <div class="ticket-top"><span>${f.air}</span><span>${f.type=='go'?'å»ç¨‹':'å›ç¨‹'}</span></div>
                    <div class="ticket-body">
                        <div><p class="city-code">${f.start}</p><p style="font-weight:bold;">${f.startT}</p></div>
                        <div style="color:#ddd; font-size:20px;"><i class="fas fa-plane"></i></div>
                        <div style="text-align:right;"><p class="city-code">${f.end}</p><p style="font-weight:bold;">${f.endT}</p></div>
                    </div>
                    <div class="ticket-divider"></div>
                    <div class="ticket-footer">
                        <div><span style="color:#999;">FLIGHT</span><br><b>${f.no}</b></div>
                        <div style="text-align:right;"><button onclick="deleteDoc(doc(db,'flights','${docSnap.id}'))" style="background:none; color:#ccc; border:none; width:auto; padding:0;">âœ•</button></div>
                    </div>
                </div>`;
            });
            document.getElementById('flight-display-area').innerHTML = html;
        });

        // 3. è¡Œç¨‹èˆ‡æ—¥æœŸåˆ‡æ›
        const dayNames = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"];
        onSnapshot(query(collection(db, "trips"), orderBy("date", "asc")), (snap) => {
            const dates = [];
            snap.forEach(d => { if(!dates.includes(d.data().date)) dates.push(d.data().date); });
            
            let btnHtml = '';
            dates.forEach(d => {
                const dateObj = new Date(d);
                const active = selectedDate == d ? 'active' : '';
                btnHtml += `
                    <div class="date-btn ${active}" onclick="selectDate('${d}')">
                        <span>${(dateObj.getMonth()+1)+'/'+dateObj.getDate()}</span>
                        <small>${dayNames[dateObj.getDay()]}</small>
                    </div>`;
            });
            document.getElementById('date-buttons').innerHTML = btnHtml;
            if(selectedDate) renderDayTrips();
        });

        window.selectDate = (date) => {
            selectedDate = date;
            document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
            renderDayTrips();
            getWeather(date);
        };

        async function renderDayTrips() {
            const qTrip = query(collection(db, "trips"), where("date", "==", selectedDate), orderBy("start", "asc"));
            const snap = await getDocs(qTrip);
            let html = '';
            let lastPlace = "";

            for (const docSnap of snap.docs) {
                const t = docSnap.data();
                const id = docSnap.id;
                
                // è¨ˆç®—åœç•™æ™‚é–“
                const diff = (new Date(`2000-01-01 ${t.end}`) - new Date(`2000-01-01 ${t.start}`)) / 60000;
                const dur = diff > 0 ? `(${Math.floor(diff/60)}h ${diff%60}m)` : "";

                // é€šå‹¤æ™‚é–“ (æš«æ™‚ç”¨æ¨¡æ“¬ï¼Œè‹¥è¦çœŸå¯¦è«‹ä¸²æ¥ Distance Matrix API)
                if(lastPlace) {
                    html += `<div class="commute-info"><i class="fas fa-car"></i> é ä¼° 25 åˆ†é˜</div>`;
                }

                html += `
                <div class="trip-card">
                    <div class="trip-header">
                        <div class="trip-content">
                            <small style="color:#7f8c8d;">${t.start} ~ ${t.end} ${dur}</small>
                            <h3 style="margin:5px 0; color:#2c3e50;">${t.place}</h3>
                            ${t.cost ? `<span style="color:#27ae60; font-weight:bold;">ğŸ’° $${t.cost}</span>` : ''}
                        </div>
                        <div class="trip-actions">
                            <button class="btn-mini btn-edit" onclick="editTripForm('${id}')">ç·¨è¼¯</button>
                            <button class="btn-mini btn-cash" onclick="cashTripForm('${id}')">è¨˜å¸³</button>
                        </div>
                    </div>
                </div>`;
                lastPlace = t.place;
            }
            document.getElementById('trip-items-area').innerHTML = html;
        }

        // 4. ç·¨è¼¯èˆ‡è¨˜å¸³
        window.saveTrip = async () => {
            const data = {
                date: document.getElementById('trip-date').value,
                place: document.getElementById('trip-place').value,
                start: document.getElementById('trip-start').value,
                end: document.getElementById('trip-end').value,
            };
            const id = document.getElementById('edit-trip-id').value;
            if(id) await updateDoc(doc(db, "trips", id), data);
            else await addDoc(collection(db, "trips"), data);
            closeModal();
        };

        window.editTripForm = async (id) => {
            const ds = await getDocs(query(collection(db, "trips")));
            const t = ds.docs.find(d => d.id == id).data();
            document.getElementById('edit-trip-id').value = id;
            document.getElementById('trip-date').value = t.date;
            document.getElementById('trip-place').value = t.place;
            document.getElementById('trip-start').value = t.start;
            document.getElementById('trip-end').value = t.end;
            showModal('modal-trip');
        };

        window.cashTripForm = (id) => {
            document.getElementById('cash-trip-id').value = id;
            document.getElementById('cash-members').innerHTML = members.map(m => `
                <label><input type="checkbox" class="cash-m-cb" value="${m}" checked> ${m}</label>
            `).join(' ');
            showModal('modal-cash');
        };

        window.saveCash = async () => {
            const id = document.getElementById('cash-trip-id').value;
            const amount = Number(document.getElementById('cash-amount').value);
            const payer = document.getElementById('cash-payer').value;
            const splitMems = Array.from(document.querySelectorAll('.cash-m-cb:checked')).map(c => c.value);
            await updateDoc(doc(db, "trips", id), { cost: amount, payer, splitWith: splitMems });
            closeModal();
            renderDayTrips();
        };

        // 5. å¤©æ°£ (æ¨¡æ“¬)
        function getWeather(date) {
            document.getElementById('weather-area').innerHTML = `<i class="fas fa-sun"></i> 24Â°C æ™´å¤©`;
        }

    </script>
</body>
</html>
