<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qiao æ—…éŠèªŒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¼•å…¥ SortableJS ç”¨æ–¼æ‹–æ›³åŠŸèƒ½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root { --glass: rgba(255, 255, 255, 0.92); --blur: blur(20px); --accent: #1e3c72; --danger: #e74c3c; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 100px; background: url('https://static.gltjp.com/glt/data/article/21000/20246/20230828_043453_d11a1481_w1920.webp') no-repeat center center fixed; background-size: cover; min-height: 100vh; color: #333; overflow-x: hidden; }
        
        .tab-content { display: none; padding: 0 10px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); padding: 40px 20px 10px; }
        #weather-box { background: rgba(0,0,0,0.35); color: white; border-radius: 15px; padding: 8px 12px; margin: 10px auto; width: fit-content; display: flex; align-items: center; gap: 6px; font-size: 13px; backdrop-filter: blur(5px); min-height: 38px; }

        /* ç™»æ©Ÿè­‰æµ®çª— */
        .boarding-pass { background: #fff; border-radius: 15px; margin: 10px 5px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border-left: 5px solid var(--accent); max-width: 95%; margin-left: auto; margin-right: auto; }
        .ticket-top { background: var(--accent); color: white; padding: 8px 12px; display: flex; justify-content: space-between; font-size: 10px; font-weight: bold; }
        .ticket-mid { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .airport-code { font-size: 24px; font-weight: 900; color: var(--accent); margin: 0; }
        .ticket-btm { padding: 10px 15px; background: #fafafa; display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 5px; border-top: 1px dashed #ddd; font-size: 10px; }
        .ticket-val { font-weight: bold; color: #222; font-size: 12px; display: block; }

        /* æ—¥æœŸé¸æ“‡å™¨ */
        .date-container { display: flex; overflow-x: auto; padding: 15px 5px; gap: 10px; scrollbar-width: none; }
        .date-item { min-width: 60px; height: 85px; background: var(--glass); border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); flex-shrink: 0; }
        .date-item.active { background: var(--accent); color: white; border: none; box-shadow: 0 5px 15px rgba(30,60,114,0.3); }
        .date-item b { font-size: 15px; margin-bottom: 3px; }
        .date-item span { font-size: 11px; opacity: 0.8; }

        /* è¡Œç¨‹å¡ç‰‡æ¨£å¼ */
        .itinerary-card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 22px; margin: 10px 0; padding: 16px; display: flex; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
        .delete-btn-tl { position: absolute; top: 8px; left: 8px; color: var(--danger); font-size: 16px; cursor: pointer; z-index: 10; opacity: 0.7; }

        .type-icon { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--accent); font-size: 18px; margin-right: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); flex-shrink: 0; }
        
        .info-col { flex: 1; display: flex; flex-direction: column; gap: 3px; }
        .time-row { font-weight: 700; font-size: 15px; color: var(--accent); display: flex; align-items: center; gap: 5px; }
        .stay-tag { font-size: 10px; background: rgba(30,60,114,0.1); color: var(--accent); padding: 1px 6px; border-radius: 8px; font-weight: bold; }
        .location-text { font-size: 16px; font-weight: bold; color: #333; line-height: 1.3; }
        .desc-text { font-size: 13px; color: #666; line-height: 1.4; }
        
        .btn-col { display: flex; flex-direction: column; gap: 4px; margin-left: 8px; }
        .btn-action { padding: 7px 10px; border-radius: 9px; border: none; font-size: 11px; font-weight: bold; color: white; cursor: pointer; width: 65px; text-align: center; }
        
        /* äº¤é€šæ™‚é–“é å·¦å°é½Š */
        .commute-info { text-align: left; color: white; font-size: 11px; margin: 4px 0 4px 50px; font-weight: 500; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 5px; }

        /* å°è¦½åˆ—å†ç¸®å° */
        .nav-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.98); height: 55px; border-radius: 28px; display: flex; box-shadow: 0 8px 25px rgba(0,0,0,0.2); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; text-decoration: none; font-size: 10px; }
        .nav-item i { font-size: 18px; margin-bottom: 2px; }
        .nav-item.active { color: var(--accent); font-weight: 900; }

        .fab { position: fixed; bottom: 85px; right: 25px; width: 50px; height: 50px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 900; border: none; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 12px; font-size: 15px; box-sizing: border-box; font-family: inherit; }
        
        .pac-container { z-index: 9999 !important; border-radius: 12px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-family: inherit; margin-top: 5px; }
        
        .preview-img { width: 100%; border-radius: 15px; margin-top: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: block; }
        .settle-card { background: #f8f9fa; border-left: 5px solid #27ae60; padding: 12px; border-radius: 10px; margin-top: 15px; font-size: 14px; text-align: left; }
        
        .btn-danger-outline { width: 100%; padding: 12px; background: white; color: var(--danger); border: 2px solid var(--danger); border-radius: 12px; font-weight: bold; margin-top: 20px; cursor: pointer; }

        /* åŒ¯ç‡æ›ç®—å™¨ */
        .currency-card { background: var(--glass); border-radius: 24px; padding: 20px; margin: 15px 5px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .currency-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .currency-label { font-size: 12px; color: #666; width: 40px; }

        /* æˆå“¡æ¸…å–®ç®¡ç†æ¨£å¼ */
        .member-row { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 15px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.05); }
        .member-avatar-preview { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: white; }
        .member-info { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .member-info input { margin: 0; padding: 8px; font-size: 13px; }
        .member-info select { margin: 0; padding: 5px; font-size: 12px; height: 32px; }
    </style>
</head>
<body>

    <div class="header"><h1 id="dynamic-trip-name">æ—…éŠèªŒ</h1></div>

    <!-- 1. é¦–é  (é¦–é æ–°å¢é ­åƒèˆ‡åŒ¯ç‡) -->
    <div id="tab-home" class="tab-content active">
        <div id="flight-display-area"></div>
        
        <div class="card" style="background:var(--glass); border-radius:24px; padding:20px; margin:15px 5px;">
            <strong style="font-size:17px; display:block; margin-bottom:15px;">æ—…ç¨‹åŸºæœ¬è¨­å®š</strong>
            
            <span style="font-size:12px; color:#666; margin-left:5px;">æ—…è¡Œåç¨±</span>
            <input type="text" id="input-trip-name" placeholder="ä¾‹å¦‚ï¼š115 åŒ—æµ·é“ä¹‹æ—…">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin: 10px 5px;">
                <span style="font-size:12px; color:#666;">æˆå“¡è¨­å®š</span>
                <button onclick="addMemberRow()" style="background:var(--accent); color:white; border:none; padding:5px 12px; border-radius:8px; font-size:11px; font-weight:bold;">+ æ–°å¢æˆå“¡</button>
            </div>
            
            <div id="members-list-container">
                <!-- æˆå“¡æ¬„ä½å‹•æ…‹æ’å…¥ -->
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1;">
                    <span style="font-size:12px; color:#666; margin-left:5px;">é–‹å§‹æ—¥æœŸ</span>
                    <input type="date" id="input-start-date">
                </div>
                <div style="flex:1;">
                    <span style="font-size:12px; color:#666; margin-left:5px;">çµæŸæ—¥æœŸ</span>
                    <input type="date" id="input-end-date">
                </div>
            </div>
            
            <button onclick="saveBaseSettings()" style="width:100%; padding:14px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:bold; margin-top:10px;">å„²å­˜è¨­å®š</button>
            <button onclick="openModal('modal-reset')" class="btn-danger-outline">é‡è¨­è³‡æ–™ (é–‹å•Ÿæ–°æ—…ç¨‹)</button>
        </div>

        <!-- åŒ¯ç‡å·¥å…· -->
        <div class="currency-card">
            <strong style="font-size:17px; display:block; margin-bottom:15px;">ğŸ’¹ åŒ¯ç‡æ›ç®— (å³æ™‚)</strong>
            <div class="currency-row">
                <span class="currency-label">æ—¥å¹£</span>
                <input type="number" id="input-jpy" placeholder="JPY" step="any" oninput="convertCurrency('JPY')">
            </div>
            <div style="text-align:center; color:var(--accent); margin: -5px 0 5px;"><i class="fas fa-exchange-alt"></i></div>
            <div class="currency-row">
                <span class="currency-label">å°å¹£</span>
                <input type="number" id="input-twd" placeholder="TWD" step="any" oninput="convertCurrency('TWD')">
            </div>
            <div id="exchange-rate-info" style="font-size:11px; color:#999; text-align:right; margin-top:5px;">è®€å–ä¸­...</div>
        </div>

        <button class="fab" onclick="openModal('modal-flight')"><i class="fas fa-plane"></i></button>
    </div>

    <!-- 2. è¡Œç¨‹é  -->
    <div id="tab-plan" class="tab-content">
        <div id="weather-box">æ­£åœ¨æŠ“å–å®šä½èˆ‡å¤©æ°£...</div>
        <div class="date-container" id="date-scroll"></div>
        <div id="itinerary-list"></div>
        <button class="fab" onclick="openModal('modal-itinerary')"><i class="fas fa-plus"></i></button>
    </div>

    <!-- 3. é™„ä»¶é  -->
    <div id="tab-files" class="tab-content">
        <div class="card" style="background:var(--glass); border-radius:24px; padding:20px; margin:15px 5px;">
            <strong>ğŸ“ é›²ç«¯é™„ä»¶</strong>
            <input type="text" id="link-name" placeholder="æª”æ¡ˆæè¿°">
            <input type="text" id="link-url" placeholder="è²¼ä¸Š Google Drive é€£çµ">
            <button onclick="saveLink()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:10px;">å„²å­˜é™„ä»¶</button>
        </div>
        <div id="link-list"></div>
    </div>

    <!-- 4. åˆ†å¸³é  -->
    <div id="tab-split" class="tab-content">
        <div class="card" style="background:var(--glass); border-radius:24px; padding:20px; margin:15px 5px; text-align:center;">
            <p style="margin:0; color:#666;">æ—…ç¨‹ç¸½æ”¯å‡º</p>
            <h1 id="total-val">$0</h1>
            <div id="personal-list"></div>
            <div id="settle-suggestions" class="settle-card">è¨ˆç®—å»ºè­°ä¸­...</div>
        </div>
    </div>

    <!-- å½ˆçª—ç¾¤çµ„ -->
    <div id="modal-itinerary" class="modal-overlay"><div class="modal-content">
        <h3>ğŸ“ ç·¨è¼¯è¡Œç¨‹</h3>
        <input type="hidden" id="edit-id">
        <select id="plan-type">
            <option value="attraction">ğŸ“ æ™¯é»</option>
            <option value="hotel">ğŸ¨ ä½å®¿</option>
            <option value="flight">âœˆï¸ é£›è¡Œ</option>
            <option value="breakfast">â˜• æ—©é¤</option>
            <option value="lunch">ğŸœ åˆé¤</option>
            <option value="dinner">ğŸº æ™šé¤</option>
        </select>
        <input type="text" id="plan-location" placeholder="åœ°é»åç¨± (Google å»ºè­°)">
        <textarea id="plan-desc" rows="3" placeholder="æ´»å‹•èªªæ˜"></textarea>
        <div style="display:flex; gap:10px;"><input type="time" id="plan-start"><input type="time" id="plan-end"></div>
        <button onclick="saveItinerary()" style="width:100%; background:var(--accent); color:white; padding:12px; border:none; border-radius:12px;">å„²å­˜</button>
        <button onclick="closeModal()" style="width:100%; background:#eee; margin-top:10px; border:none; padding:10px; border-radius:12px;">å–æ¶ˆ</button>
    </div></div>

    <div id="modal-flight" class="modal-overlay"><div class="modal-content">
        <h3>âœˆï¸ ç™»æ©Ÿè­‰è¨­å®š</h3>
        <select id="f-type"><option value="go">å»ç¨‹</option><option value="back">å›ç¨‹</option></select>
        <input type="text" id="f-air" placeholder="èˆªç©ºå…¬å¸"><input type="text" id="f-no" placeholder="èˆªç­è™Ÿç¢¼">
        <div style="display:flex; gap:10px;"><input type="text" id="f-from" placeholder="TPE"><input type="time" id="f-from-t"></div>
        <div style="display:flex; gap:10px;"><input type="text" id="f-to" placeholder="CTS"><input type="time" id="f-to-t"></div>
        <button onclick="saveFlight()" style="width:100%; background:var(--accent); color:white; padding:12px; border:none; border-radius:12px;">å„²å­˜</button>
        <button onclick="closeModal()" style="width:100%; background:#eee; margin-top:10px; border:none; padding:10px; border-radius:12px;">å–æ¶ˆ</button>
    </div></div>

    <div id="modal-payment" class="modal-overlay"><div class="modal-content">
        <h3>ğŸ’° è¨˜å¸³åˆ†æ”¤</h3>
        <input type="hidden" id="pay-trip-id">
        <input type="number" id="pay-amount" placeholder="é‡‘é¡">
        <select id="pay-payer"></select>
        <div id="pay-split-list" style="margin-top:10px; font-size:13px;"></div>
        <button onclick="saveExpense()" style="width:100%; background:#27ae60; color:white; padding:12px; border:none; border-radius:12px;">å„²å­˜å¸³ç›®</button>
        <button onclick="closeModal()" style="width:100%; background:#eee; margin-top:10px; border:none; padding:10px; border-radius:12px;">å–æ¶ˆ</button>
    </div></div>

    <div id="modal-reset" class="modal-overlay"><div class="modal-content">
        <h3 style="color:var(--danger);"><i class="fas fa-exclamation-triangle"></i> ç¢ºå®šæ¸…é™¤è³‡æ–™ï¼Ÿ</h3>
        <p>é€™æœƒæ¸…ç©ºè¡Œç¨‹ã€å¸³ç›®ã€èˆªç­èˆ‡é™„ä»¶ï¼Œè«‹ç¢ºèªå·²å‚™ä»½é‡è¦è³‡è¨Šã€‚</p>
        <button onclick="resetAllData()" style="width:100%; background:var(--danger); color:white; padding:12px; border:none; border-radius:12px; font-weight:bold;">æ¸…é™¤ä¸¦é‡ç½®</button>
        <button onclick="closeModal()" style="width:100%; background:#eee; margin-top:10px; border:none; padding:10px; border-radius:12px;">è¿”å›</button>
    </div></div>

    <!-- å°è¦½ -->
    <div class="nav-bar">
        <a href="javascript:void(0)" class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home"></i><span>é¦–é </span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-plan', this)"><i class="fas fa-calendar-alt"></i><span>è¡Œç¨‹</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-files', this)"><i class="fas fa-paperclip"></i><span>é™„ä»¶</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-split', this)"><i class="fas fa-coins"></i><span>åˆ†å¸³</span></a>
    </div>

    <!-- åœ°é»æœå°‹ -->
    <script>
        window.initAutocomplete = function() {
            const input = document.getElementById('plan-location');
            if(!input) return;
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.setFields(['name', 'geometry', 'formatted_address']);
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.name) input.value = place.name;
                else if (place.formatted_address) input.value = place.formatted_address;
            });
        };
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZOejBZ46GgLgG8sFbVtuYp6fcqUn44w4&libraries=places&callback=initAutocomplete" async defer></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, updateDoc, getDoc, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCcXPvCma5TilSjZfAGYJg8n8ZfAAsqNtE", authDomain: "my-travel-app-b029c.firebaseapp.com", projectId: "my-travel-app-b029c", storageBucket: "my-travel-app-b029c.appspot.com", messagingSenderId: "898590101576", appId: "1:898590101576:web:7c1916bb7ebbada144487d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const WEATHER_KEY = "c8f4d0fbf6c2b1cded4335d40c62d3f5";
        let currentMembers = [], selectedDate = "";
        let exchangeRate = 0.22;

        // åŒ—æµ·é“å‹•ç‰©é ­åƒ
        const AVATAR_OPTIONS = [
            { name: 'åŒ—ç‹', url: 'image_5252f4.png' },
            { name: 'è¦å¤·å°é£›é¼ ', url: 'image_525023.png' },
            { name: 'è¦å¤·é³´å…”', url: 'image_525047.png' },
            { name: 'è¦å¤·é¹¿', url: 'image_525041.png' },
            { name: 'ä¸¹é ‚é¶´', url: 'image_525332.png' },
            { name: 'æ£•ç†Š', url: 'image_525310.png' },
            { name: 'éŠ€å–‰é•·å°¾å±±é›€', url: 'image_52532b.png' },
            { name: 'è™é ­æµ·éµ°', url: 'image_5252ee.png' }
        ];

        const typeIcons = {
            attraction: 'fa-map-marker-alt',
            hotel: 'fa-hotel',
            flight: 'fa-plane',
            breakfast: 'fa-coffee',
            lunch: 'fa-utensils',
            dinner: 'fa-moon'
        };

        // --- æˆå“¡è¨­å®š ---
        window.addMemberRow = (name = '', avatar = AVATAR_OPTIONS[0].url) => {
            const container = document.getElementById('members-list-container');
            const row = document.createElement('div');
            row.className = 'member-row';
            
            let optionsHtml = AVATAR_OPTIONS.map(opt => `<option value="${opt.url}" ${opt.url === avatar ? 'selected' : ''}>${opt.name}</option>`).join('');

            row.innerHTML = `
                <img src="${avatar}" class="member-avatar-preview" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                <div class="member-info">
                    <input type="text" class="member-name-input" value="${name}" placeholder="å§“å">
                    <select class="member-avatar-select" onchange="this.parentElement.previousElementSibling.src = this.value">
                        ${optionsHtml}
                    </select>
                </div>
                <button onclick="this.parentElement.remove()" style="background:none; border:none; color:#ccc; padding: 10px;"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(row);
        };

        // --- åŒ¯ç‡ ---
        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/JPY');
                const data = await res.json();
                exchangeRate = data.rates.TWD;
                document.getElementById('exchange-rate-info').innerText = `1 JPY â‰ˆ ${exchangeRate.toFixed(4)} TWD (å³æ™‚)`;
            } catch (e) { document.getElementById('exchange-rate-info').innerText = "åŒ¯ç‡æ›´æ–°å¤±æ•—ã€‚"; }
        }
        fetchExchangeRate();

        window.convertCurrency = (type) => {
            const jpyInput = document.getElementById('input-jpy');
            const twdInput = document.getElementById('input-twd');
            if (type === 'JPY') twdInput.value = (jpyInput.value * exchangeRate).toFixed(2);
            else jpyInput.value = (twdInput.value / exchangeRate).toFixed(2);
        };

        // --- é‡ç½® ---
        window.resetAllData = async () => {
            const collectionsToClear = ["itinerary", "expenses", "links", "flights"];
            try {
                for (const colName of collectionsToClear) {
                    const snap = await getDocs(collection(db, colName));
                    for (const d of snap.docs) await deleteDoc(doc(db, colName, d.id));
                }
                await deleteDoc(doc(db, "settings", "currentTrip"));
                window.location.reload();
            } catch (e) { alert("é‡è¨­å¤±æ•—ã€‚"); }
        };

        // --- GPS èˆ‡å¤©æ°£ ---
        async function updateWeather(fallbackLoc) {
            const weatherBox = document.getElementById('weather-box');
            const getW = async (params) => {
                try {
                    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?${params}&appid=${WEATHER_KEY}&units=metric&lang=zh_tw`);
                    const d = await res.json();
                    if(d.cod===200) { 
                        weatherBox.innerHTML = `<i class="fas fa-location-arrow" style="font-size:11px;opacity:0.7;"></i> <img src="https://openweathermap.org/img/wn/${d.weather[0].icon}.png" width="28"><b>${d.name}: ${Math.round(d.main.temp)}Â°C</b>`; 
                        return true; 
                    }
                    return false;
                } catch(e){return false;}
            };
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async(pos)=> { await getW(`lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`); },
                    async()=>{ if (fallbackLoc) await tryFallbackWeather(fallbackLoc, getW); }, 
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else if(fallbackLoc) await tryFallbackWeather(fallbackLoc, getW);
        }

        async function tryFallbackWeather(loc, fetchFn) {
            if(!loc) return;
            let city = loc.split(/[ ,ï¼Œã€]/)[0];
            const match = loc.match(/.*?(å¸‚|ç¸£|å€|ç”º|æ‘)/);
            if (match) city = match[0].split(/å¸‚|ç¸£|å€|ç”º|æ‘/).pop() || match[0];
            let success = await fetchFn(`q=${encodeURIComponent(city)}`);
            if(!success) await fetchFn(`q=${encodeURIComponent(city.substring(0,2))}`);
        }

        // --- è¡Œç¨‹åŠŸèƒ½ ---
        window.saveItinerary = async () => {
            if(!selectedDate) return alert("è«‹å…ˆé¸æ“‡æ—¥æœŸã€‚");
            const data = { 
                date: selectedDate, 
                type: document.getElementById('plan-type').value,
                location: document.getElementById('plan-location').value, 
                desc: document.getElementById('plan-desc').value, 
                start: document.getElementById('plan-start').value, 
                end: document.getElementById('plan-end').value, 
                updatedAt: new Date() 
            };
            const id = document.getElementById('edit-id').value;
            if(id) await updateDoc(doc(db, "itinerary", id), data);
            else await addDoc(collection(db, "itinerary"), data);
            closeModal(); refreshItinerary();
        };

        async function refreshItinerary() {
            if(!selectedDate) return;
            const q = query(collection(db, "itinerary"), where("date", "==", selectedDate), orderBy("start", "asc"));
            const snap = await getDocs(q);
            const listEl = document.getElementById('itinerary-list');
            let html = '', docs = snap.docs;
            updateWeather(docs.length > 0 ? docs[0].data().location : null);
            for(let i=0; i<docs.length; i++) {
                const d = docs[i].data(), id = docs[i].id;
                const iconClass = typeIcons[d.type] || 'fa-map-marker-alt';
                html += `
                    <div class="itinerary-card" data-id="${id}">
                        <div class="delete-btn-tl" onclick="window.deletePlan('${id}')"><i class="fas fa-times-circle"></i></div>
                        <div class="type-icon"><i class="fas ${iconClass}"></i></div>
                        <div class="info-col">
                            <div class="time-row">${d.start} - ${d.end}<span class="stay-tag">${getTimeDiff(d.start, d.end)}</span></div>
                            <div class="location-text">${d.location}</div>
                            ${d.desc ? `<div class="desc-text">${d.desc}</div>` : ''}
                        </div>
                        <div class="btn-col">
                            <button class="btn-action" style="background:#f39c12" onclick="window.openOnGoogleMaps('${d.location}')"><i class="fas fa-directions"></i></button>
                            <button class="btn-action" style="background:#3498db" onclick="window.editPlan('${id}')">ç·¨è¼¯</button>
                            <button class="btn-action" style="background:#27ae60" onclick="window.openPayment('${id}')">è¨˜å¸³</button>
                        </div>
                    </div>`;
                if(i < docs.length - 1) {
                    const time = await getCommute(d.location, docs[i+1].data().location);
                    html += `<div class="commute-info"><i class="fas fa-car"></i> ç´„ ${time}</div>`;
                }
            }
            listEl.innerHTML = html || '<p style="text-align:center; color:white;">æœ¬æ—¥ç„¡è¡Œç¨‹è¨ˆç•«ã€‚</p>';
            new Sortable(listEl, { animation: 150, delay: 300, delayOnTouchOnly: true });
        }

        window.openOnGoogleMaps = (location) => {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`, '_blank');
        };

        window.deletePlan = async (id) => {
            if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await deleteDoc(doc(db, "itinerary", id)); refreshItinerary(); }
        };

        window.editPlan = async (id) => {
            const ds = await getDoc(doc(db, "itinerary", id));
            const d = ds.data();
            document.getElementById('edit-id').value = id;
            document.getElementById('plan-type').value = d.type || 'attraction';
            document.getElementById('plan-location').value = d.location;
            document.getElementById('plan-desc').value = d.desc || "";
            document.getElementById('plan-start').value = d.start;
            document.getElementById('plan-end').value = d.end;
            openModal('modal-itinerary');
        };

        function getTimeDiff(s, e) {
            if(!s || !e) return "";
            const [sh, sm] = s.split(':').map(Number), [eh, em] = e.split(':').map(Number);
            let diff = (eh * 60 + em) - (sh * 60 + sm);
            if(diff < 0) diff += 1440;
            return `åœç•™ ${Math.floor(diff/60)}h${diff%60}m`;
        }

        async function getCommute(o, d) {
            return new Promise((resolve) => {
                const s = new google.maps.DistanceMatrixService();
                s.getDistanceMatrix({ origins: [o], destinations: [d], travelMode: 'DRIVING' }, (res, stat) => {
                    if (stat==='OK' && res.rows[0].elements[0].status==='OK') resolve(res.rows[0].elements[0].duration.text);
                    else resolve("...");
                });
            });
        }

        window.saveBaseSettings = async () => {
            const memberRows = document.querySelectorAll('.member-row');
            const members = Array.from(memberRows).map(row => ({
                name: row.querySelector('.member-name-input').value.trim(),
                avatar: row.querySelector('.member-avatar-select').value
            })).filter(m => m.name !== "");

            const data = { tripName: document.getElementById('input-trip-name').value, members, start: document.getElementById('input-start-date').value, end: document.getElementById('input-end-date').value };
            await setDoc(doc(db, "settings", "currentTrip"), data);
            alert("æ—…ç¨‹è¨­å®šå„²å­˜æˆåŠŸï¼");
        };

        onSnapshot(doc(db, "settings", "currentTrip"), (snap) => {
            if (snap.exists()) {
                const d = snap.data();
                document.getElementById('dynamic-trip-name').innerText = d.tripName || "æ—…éŠèªŒ";
                document.getElementById('input-trip-name').value = d.tripName || "";
                document.getElementById('input-start-date').value = d.start || "";
                document.getElementById('input-end-date').value = d.end || "";
                
                const container = document.getElementById('members-list-container');
                container.innerHTML = '';
                if(d.members) d.members.forEach(m => addMemberRow(m.name, m.avatar));
                
                currentMembers = d.members || [];
                renderDates(d.start, d.end);
            }
        });

        function renderDates(s, e) {
            if(!s || !e) return;
            let html = '', curr = new Date(s), last = new Date(e);
            while(curr <= last) {
                const dStr = curr.toISOString().split('T')[0], mmdd = (curr.getMonth()+1) + '/' + curr.getDate(), day = curr.toLocaleDateString('zh-TW', { weekday: 'short' });
                html += `<div class="date-item ${selectedDate==dStr?'active':''}" onclick="window.selectDate('${dStr}')"><b>${mmdd}</b><span>${day}</span></div>`;
                curr.setDate(curr.getDate() + 1);
            }
            document.getElementById('date-scroll').innerHTML = html;
            if(!selectedDate) window.selectDate(s);
        }

        window.selectDate = (d) => {
            selectedDate = d;
            document.querySelectorAll('.date-item').forEach(el => {
                const b = el.querySelector('b').innerText;
                const dObj = new Date(d);
                el.classList.toggle('active', b == ((dObj.getMonth()+1)+'/'+dObj.getDate()));
            });
            refreshItinerary();
        };

        // --- èˆªç­ ---
        onSnapshot(collection(db, "flights"), (snap) => {
            let html = '';
            snap.forEach(dSnap => {
                const f = dSnap.data();
                const [sh, sm] = f.fromT.split(':').map(Number), [eh, em] = f.toT.split(':').map(Number);
                let diff = (eh * 60 + em) - (sh * 60 + sm);
                if(diff < 0) diff += 1440;
                html += `<div class="boarding-pass">
                    <div class="ticket-top"><span>${f.air} ${f.no}</span><span>${f.type=='go'?'å»ç¨‹':'å›ç¨‹'}</span></div>
                    <div class="ticket-mid">
                        <div style="text-align:left;"><p class="airport-code">${f.from}</p><span style="font-size:12px;font-weight:bold;">${f.fromT}</span></div>
                        <div style="text-align:center;flex:1;position:relative;"><span style="font-size:9px;color:#999;position:absolute;top:-12px;left:50%;transform:translateX(-50%);">${Math.floor(diff/60)}h ${diff%60}m</span><i class="fas fa-plane" style="color:#eee;font-size:18px;"></i></div>
                        <div style="text-align:right;"><p class="airport-code">${f.to}</p><span style="font-size:12px;font-weight:bold;">${f.toT}</span></div>
                    </div>
                </div>`;
            });
            document.getElementById('flight-display-area').innerHTML = html;
        });

        window.saveFlight = async () => {
            const t = document.getElementById('f-type').value;
            await setDoc(doc(db, "flights", t), { air: document.getElementById('f-air').value, no: document.getElementById('f-no').value, from: document.getElementById('f-from').value.toUpperCase(), fromT: document.getElementById('f-from-t').value, to: document.getElementById('f-to').value.toUpperCase(), toT: document.getElementById('f-to-t').value, type: t });
            closeModal();
        };

        // --- é™„ä»¶ ---
        window.saveLink = async () => {
            await addDoc(collection(db, "links"), { name: document.getElementById('link-name').value, url: document.getElementById('link-url').value, createdAt: new Date() });
            document.getElementById('link-name').value = ''; document.getElementById('link-url').value = '';
        };

        onSnapshot(query(collection(db, "links"), orderBy("createdAt", "desc")), (snap) => {
            let html = '';
            snap.forEach(d => {
                const data = d.data(), id = d.id;
                let fId = data.url.includes('/d/') ? data.url.split('/d/')[1].split('/')[0] : '';
                let pre = fId ? `<img src="https://drive.google.com/thumbnail?id=${fId}&sz=w800" class="preview-img">` : '';
                html += `<div class="itinerary-card" style="padding:15px;"><div class="delete-btn-tl" style="top:5px; left:5px;" onclick="window.deleteLink('${id}')"><i class="fas fa-times-circle"></i></div><div style="flex:1; padding-left:15px;"><b style="font-size:15px;">${data.name}</b><br><a href="${data.url}" target="_blank" style="color:var(--accent); font-size:11px;">é–‹å•Ÿé€£çµ <i class="fas fa-external-link-alt"></i></a>${pre}</div></div>`;
            });
            document.getElementById('link-list').innerHTML = html;
        });
        window.deleteLink = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db, "links", id)); };

        // --- åˆ†å¸³ ---
        async function refreshSettlement() {
            const snap = await getDocs(collection(db, "expenses"));
            let total = 0, balances = {};
            currentMembers.forEach(m => balances[m.name] = 0);
            snap.forEach(d => {
                const data = d.data(); total += data.amount;
                if(balances.hasOwnProperty(data.payer)) balances[data.payer] += data.amount;
                const per = data.amount / data.splitTo.length;
                data.splitTo.forEach(m => { if(balances.hasOwnProperty(m)) balances[m] -= per; });
            });
            document.getElementById('total-val').innerText = "$" + Math.round(total).toLocaleString();
            let html = '';
            Object.keys(balances).forEach(m => {
                const b = Math.round(balances[m]);
                const c = b >= 0 ? "#27ae60" : "#e74c3c";
                html += `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee;"><span>${m}</span><b style="color:${c}">${b>=0?'+':''}${b.toLocaleString()}</b></div>`;
            });
            document.getElementById('personal-list').innerHTML = html;
            calculateSettle(balances);
        }

        function calculateSettle(balances) {
            let debtors = [], creditors = [];
            Object.keys(balances).forEach(m => {
                if (balances[m] < -1) debtors.push({ name: m, amount: -balances[m] });
                else if (balances[m] > 1) creditors.push({ name: m, amount: balances[m] });
            });
            let sug = "<strong>ğŸ’¡ çµç®—å»ºè­°ï¼š</strong><br>";
            let i=0, j=0;
            while(i < debtors.length && j < creditors.length) {
                let p = Math.min(debtors[i].amount, creditors[j].amount);
                sug += `${debtors[i].name} â¡ï¸ çµ¦ ${creditors[j].name} <b>$${Math.round(p).toLocaleString()}</b><br>`;
                debtors[i].amount -= p; creditors[j].amount -= p;
                if(debtors[i].amount < 1) i++; if(creditors[j].amount < 1) j++;
            }
            document.getElementById('settle-suggestions').innerHTML = debtors.length === 0 ? "å¸³ç›®å·²çµæ¸…" : sug;
        }

        window.openPayment = (id) => {
            document.getElementById('pay-trip-id').value = id;
            let opt = '', chk = '';
            currentMembers.forEach(m => { opt += `<option value="${m.name}">${m.name}</option>`; chk += `<label style="display:block; margin:5px 0;"><input type="checkbox" class="split-cb" value="${m.name}" checked> ${m.name}</label>`; });
            document.getElementById('pay-payer').innerHTML = opt;
            document.getElementById('pay-split-list').innerHTML = `<p style="font-size:12px;">åˆ†æ”¤æˆå“¡ï¼š</p>${chk}`;
            openModal('modal-payment');
        };

        window.saveExpense = async () => {
            await addDoc(collection(db, "expenses"), { amount: Number(document.getElementById('pay-amount').value), payer: document.getElementById('pay-payer').value, splitTo: [...document.querySelectorAll('.split-cb:checked')].map(c => c.value), date: selectedDate });
            alert("å¸³ç›®å·²ç´€éŒ„ã€‚"); closeModal(); refreshSettlement();
        };

        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        };
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
            document.getElementById('edit-id').value = '';
            document.getElementById('plan-location').value = '';
            document.getElementById('plan-desc').value = '';
            document.getElementById('plan-start').value = '';
            document.getElementById('plan-end').value = '';
        };

        refreshSettlement();
    </script>
</body>
</html>
