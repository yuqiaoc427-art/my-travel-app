<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qiao æ—…éŠèªŒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.85); 
            --blur: blur(15px); 
            --accent: #1e3c72; 
            --danger: #e74c3c; 
            --success: #27ae60;
            --secondary: #95a5a6;
            --shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; padding-bottom: 100px; 
            background: url('https://static.gltjp.com/glt/data/article/21000/20246/20230828_043453_d11a1481_w1920.webp') no-repeat center center fixed; 
            background-size: cover; min-height: 100vh; color: #333; overflow-x: hidden; 
        }

        /* å…¨åŸŸå¡ç‰‡èˆ‡å¾®å‹•æ•ˆ */
        .card { 
            background: var(--glass); 
            backdrop-filter: var(--blur); 
            border-radius: 24px; 
            margin: 15px 5px; 
            padding: 20px; 
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.2s ease, opacity 0.3s ease;
        }

        .tab-content { display: none; padding: 0 12px; }
        .tab-content.active { 
            display: block; 
            animation: slideUp 0.4s ease forwards; 
        }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* æŒ‰éˆ•è‰²å½©è¦ç¯„ */
        .btn-main { background: var(--accent); color: white; border: none; }
        .btn-assist { background: var(--secondary); color: white; border: none; }
        .btn-danger-outline { background: transparent; color: var(--danger); border: 2px solid var(--danger); }
        .btn-action-small { padding: 8px; border-radius: 12px; font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-action-small:active { transform: scale(0.95); }

        /* è¡Œç¨‹é æ™‚é–“è»¸å„ªåŒ– */
        #itinerary-list { position: relative; padding-left: 20px; }
        #itinerary-list::before { 
            content: ''; position: absolute; left: 10px; top: 20px; bottom: 20px;
            width: 2px; border-left: 2px dashed rgba(30, 60, 114, 0.3);
        }
        .itinerary-card { position: relative; display: flex; align-items: center; margin-left: 15px; }
        .itinerary-card::before {
            content: ''; position: absolute; left: -30px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 12px; background: var(--accent); border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ç‹€æ…‹æ¨™ç±¤è‰²åˆ† */
        .type-icon.attraction { background: #3498db; color: white; }
        .type-icon.hotel { background: #9b59b6; color: white; }
        .type-icon.flight { background: #34495e; color: white; }
        .type-icon.food { background: #e67e22; color: white; } /* æ—©é¤åˆé¤æ™šé¤å…±ç”¨ */

        /* é€šå‹¤è³‡è¨Šç¾åŒ– */
        .commute-container {
            display: flex; align-items: center; gap: 10px; margin: -5px 0 -5px 45px;
            padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 12px;
            font-size: 11px; color: white; width: fit-content; backdrop-filter: blur(5px);
        }

        /* ç™»æ©Ÿè­‰ Apple Wallet é¢¨æ ¼ */
        .boarding-pass { 
            background: #fff; border-radius: 20px; margin: 15px 5px; 
            position: relative; box-shadow: var(--shadow); overflow: hidden;
        }
        .boarding-pass::before, .boarding-pass::after {
            content: ''; position: absolute; top: 55px; width: 20px; height: 20px;
            background: rgba(0,0,0,0.1); border-radius: 50%; z-index: 5;
        }
        .boarding-pass::before { left: -10px; }
        .boarding-pass::after { right: -10px; }

        /* å‚µå‹™å¡ç‰‡åŒ– */
        .debt-card {
            display: flex; align-items: center; justify-content: space-between;
            background: white; padding: 15px; border-radius: 18px; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .debt-arrow { color: var(--secondary); font-size: 12px; flex: 1; text-align: center; }

        /* å…¶é¤˜ç¶­æŒä¸è®Šçš„å¿…è¦æ¨£å¼ */
        .nav-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.98); height: 55px; border-radius: 28px; display: flex; box-shadow: 0 8px 25px rgba(0,0,0,0.2); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; text-decoration: none; font-size: 10px; }
        .nav-item.active { color: var(--accent); font-weight: 900; }
        .fab { position: fixed; bottom: 85px; right: 25px; width: 50px; height: 50px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 900; border: none; }
        .type-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; }
        .preview-box-container { position: relative; margin-top: 10px; display: none; }
        .preview-box { width: 100%; border-radius: 12px; }
        .remove-file-badge { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header"><h1 id="dynamic-trip-name">æ—…éŠèªŒ</h1></div>

    <div id="tab-home" class="tab-content active">
        <div id="flight-display-area"></div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <strong style="font-size:17px;">æ—…ç¨‹åŸºæœ¬è¨­å®š</strong>
                <button onclick="toggleMemberEdit()" id="member-toggle-btn" class="btn-action-small btn-assist">å±•é–‹æˆå“¡</button>
            </div>
            
            <div id="settings-collapsible" style="display:none;">
                <span style="font-size:12px; color:#666; margin-left:5px;">æ—…è¡Œåç¨±</span>
                <input type="text" id="input-trip-name" placeholder="ä¾‹å¦‚ï¼š115 åŒ—æµ·é“ä¹‹æ—…">
                <div style="display:flex; justify-content:space-between; align-items:center; margin: 10px 5px;">
                    <span style="font-size:12px; color:#666;">æˆå“¡è¨­å®š</span>
                    <button onclick="addMemberRow()" class="btn-action-small btn-main">+ æ–°å¢æˆå“¡</button>
                </div>
                <div id="members-list-container"></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1;"><span style="font-size:12px; color:#666;">é–‹å§‹æ—¥æœŸ</span><input type="date" id="input-start-date"></div>
                    <div style="flex:1;"><span style="font-size:12px; color:#666;">çµæŸæ—¥æœŸ</span><input type="date" id="input-end-date"></div>
                </div>
                <button onclick="saveBaseSettings()" class="btn-main" style="width:100%; padding:14px; border-radius:12px; font-weight:bold; margin-top:10px;">å„²å­˜è¨­å®š</button>
                <button onclick="openModal('modal-reset')" class="btn-danger-outline" style="width:100%; padding:12px; border-radius:12px; font-weight:bold; margin-top:15px;">é‡è¨­è³‡æ–™</button>
            </div>

            <div id="member-avatars-summary" style="display:flex; gap:8px; overflow-x:auto; padding:5px;"></div>
        </div>

        <div class="card currency-card">
            <strong style="font-size:17px; display:block; margin-bottom:15px;">ğŸ’¹ åŒ¯ç‡æ›ç®—</strong>
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><span style="font-size:12px; width:40px;">æ—¥å¹£</span><input type="number" id="input-jpy" oninput="convertCurrency('JPY')"></div>
            <div style="text-align:center; color:var(--accent); margin: -5px 0 5px;"><i class="fas fa-exchange-alt"></i></div>
            <div style="display:flex; align-items:center; gap:10px;"><span style="font-size:12px; width:40px;">å°å¹£</span><input type="number" id="input-twd" oninput="convertCurrency('TWD')"></div>
            <div id="exchange-rate-info" style="font-size:11px; color:#999; text-align:right;">è®€å–ä¸­...</div>
        </div>
        <button class="fab" onclick="openModal('modal-flight')"><i class="fas fa-plane"></i></button>
    </div>

    <div id="tab-plan" class="tab-content">
        <div id="weather-box" style="color:white; text-align:center; padding:10px;">å®šä½ä¸­...</div>
        <div class="date-container" id="date-scroll"></div>
        <div id="itinerary-list"></div>
        <button class="fab" onclick="openModal('modal-itinerary')"><i class="fas fa-plus"></i></button>
    </div>

    <div id="tab-split" class="tab-content">
        <div id="settle-suggestions" class="card" style="padding:15px;">æ­£åœ¨è¨ˆç®—å»ºè­°...</div>
        <div class="card" style="text-align:center;">
            <p style="margin:0; color:#666;">æ—…ç¨‹ç¸½æ”¯å‡º</p>
            <h1 id="total-val" style="margin: 5px 0;">$0</h1>
            <div id="personal-list"></div>
        </div>
        <div class="card">
            <strong>èŠ±è²»æ˜ç´°</strong>
            <div id="expense-detail-list" style="margin-top:10px;"></div>
        </div>
        <button class="fab" onclick="window.openPayment()"><i class="fas fa-plus"></i></button>
    </div>

    <div id="modal-payment" class="modal-overlay"><div class="modal-content">
        <h3 id="payment-modal-title">ğŸ’° è¨˜å¸³</h3>
        <input type="hidden" id="edit-expense-id">
        <input type="text" id="pay-name" placeholder="é …ç›®åç¨±">
        <div style="display:flex; gap:10px;">
            <select id="pay-currency" onchange="updateConvertHint()"><option value="TWD">å°å¹£</option><option value="JPY">æ—¥åœ“</option></select>
            <input type="number" id="pay-amount" placeholder="é‡‘é¡" oninput="updateConvertHint()">
        </div>
        <span id="convert-hint" class="convert-hint"></span>
        <select id="pay-payer"></select>
        <div id="pay-split-list"></div>
        <textarea id="pay-note" rows="2" placeholder="å‚™è¨»..."></textarea>
        <input type="file" id="pay-file" onchange="previewExpenseFile(this)">
        <div id="preview-wrapper" class="preview-container"><button class="remove-file-badge" onclick="removeExpenseFile()">âœ•</button><img id="expense-img-preview" class="preview-box"></div>
        <button onclick="saveExpense()" class="btn-main" style="width:100%; padding:12px; border-radius:12px; margin-top:15px;">å„²å­˜å¸³ç›®</button>
        <button id="del-expense-btn" onclick="deleteExpenseReal()" class="btn-danger-outline" style="width:100%; padding:12px; border-radius:12px; margin-top:5px; display:none;">åˆªé™¤æ­¤ç­†</button>
        <button onclick="closeModal()" class="btn-assist" style="width:100%; margin-top:10px; border:none; padding:10px; border-radius:12px;">å–æ¶ˆ</button>
    </div></div>

    <div class="nav-bar">
        <a href="javascript:void(0)" class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home"></i><span>é¦–é </span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-plan', this)"><i class="fas fa-calendar-alt"></i><span>è¡Œç¨‹</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-split', this)"><i class="fas fa-coins"></i><span>åˆ†å¸³</span></a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, updateDoc, getDoc, getDocs, where, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config (ä½¿ç”¨ä½ åŸæœ¬çš„)
        const firebaseConfig = { apiKey: "AIzaSyCcXPvCma5TilSjZfAGYJg8n8ZfAAsqNtE", authDomain: "my-travel-app-b029c.firebaseapp.com", projectId: "my-travel-app-b029c", storageBucket: "my-travel-app-b029c.appspot.com", messagingSenderId: "898590101576", appId: "1:898590101576:web:7c1916bb7ebbada144487d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentMembers = [], selectedDate = "", exchangeRate = 0.22;
        const typeIcons = { attraction: 'fa-map-marker-alt', hotel: 'fa-hotel', flight: 'fa-plane', breakfast: 'fa-coffee', lunch: 'fa-utensils', dinner: 'fa-moon' };

        // --- é¦–é äº’å‹•ï¼šç²¾ç°¡æˆå“¡æ¸…å–® ---
        window.toggleMemberEdit = () => {
            const content = document.getElementById('settings-collapsible');
            const btn = document.getElementById('member-toggle-btn');
            if(content.style.display === 'none') {
                content.style.display = 'block';
                btn.innerText = 'æ”¶åˆè¨­å®š';
            } else {
                content.style.display = 'none';
                btn.innerText = 'å±•é–‹è¨­å®š';
            }
        };

        // --- è¡Œç¨‹æ¸²æŸ“ï¼šè™›ç·šæ™‚é–“è»¸èˆ‡é€šå‹¤ç¾åŒ– ---
        window.refreshItinerary = async () => {
            if(!selectedDate) return;
            const q = query(collection(db, "itinerary"), where("date", "==", selectedDate), orderBy("start", "asc"));
            const snap = await getDocs(q);
            const listEl = document.getElementById('itinerary-list');
            let html = '', docs = snap.docs;
            
            for(let i=0; i<docs.length; i++) {
                const d = docs[i].data(), id = docs[i].id;
                const typeClass = (d.type === 'hotel') ? 'hotel' : (d.type === 'attraction' ? 'attraction' : (d.type === 'flight' ? 'flight' : 'food'));
                const icon = typeIcons[d.type] || 'fa-map-marker-alt';
                
                html += `
                    <div class="card itinerary-card" data-id="${id}">
                        <div class="delete-btn-tl" onclick="window.deletePlan('${id}')"><i class="fas fa-times-circle"></i></div>
                        <div class="type-icon ${typeClass}"><i class="fas ${icon}"></i></div>
                        <div class="info-col">
                            <div class="time-row">${d.start} - ${d.end}<span class="stay-tag">${getTimeDiff(d.start, d.end)}</span></div>
                            <div class="location-text">${d.location}</div>
                        </div>
                        <div class="btn-col">
                            <button class="btn-action-small btn-assist" onclick="window.editPlan('${id}')">ç·¨è¼¯</button>
                        </div>
                    </div>`;
                
                if(i < docs.length - 1) {
                    const time = await getCommute(d.location, docs[i+1].data().location);
                    html += `
                        <div class="commute-container">
                            <i class="fas fa-car-side"></i> <span>ç´„ ${time}</span>
                            <button onclick="window.openOnGoogleMaps('${docs[i+1].data().location}')" style="background:none; border:none; color:white; padding:0; cursor:pointer;"><i class="fas fa-location-arrow"></i></button>
                        </div>`;
                }
            }
            listEl.innerHTML = html || '<p style="text-align:center; color:white;">ç„¡è¡Œç¨‹è¨ˆç•«ã€‚</p>';
            new Sortable(listEl, { animation: 150 });
        };

        // --- åˆ†å¸³æ¸²æŸ“ï¼šå‚µå‹™å¡ç‰‡åŒ–èˆ‡å¹£åˆ¥æ¨™ç¤º ---
        function updateSettleUI(balances) {
            let listHtml = '', debtors = [], creditors = [];
            Object.keys(balances).forEach(m => {
                const b = Math.round(balances[m]);
                listHtml += `<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:14px;border-bottom:1px solid rgba(0,0,0,0.05);"><span>${m}</span><b style="color:${b>=0?'var(--success)':'var(--danger)'}">${b>=0?'+':''}${b.toLocaleString()}</b></div>`;
                if(b < -1) debtors.push({n:m, a:-b}); else if(b > 1) creditors.push({n:m, a:b});
            });
            document.getElementById('personal-list').innerHTML = listHtml;

            let sug = "<strong>ğŸ’¡ çµç®—å»ºè­°</strong><div style='margin-top:10px;'>", i=0, j=0;
            while(i<debtors.length && j<creditors.length) {
                let p = Math.min(debtors[i].a, creditors[j].a);
                sug += `
                    <div class="debt-card">
                        <b>${debtors[i].n}</b>
                        <div class="debt-arrow">â”€â”€ $${Math.round(p)} â”€â†’</div>
                        <b>${creditors[j].n}</b>
                    </div>`;
                debtors[i].a -= p; creditors[j].a -= p;
                if(debtors[i].a < 1) i++; if(creditors[j].a < 1) j++;
            }
            sug += "</div>";
            document.getElementById('settle-suggestions').innerHTML = (debtors.length===0) ? "âœ… å¸³ç›®å·²çµæ¸…" : sug;
        }

        // --- æ˜ç´°æ¸²æŸ“ï¼šå¹£åˆ¥æ¨™ç¤º ---
        onSnapshot(query(collection(db, "expenses"), orderBy("createdAt", "desc")), (snap) => {
            let total = 0, detailHtml = '', balances = {};
            currentMembers.forEach(m => balances[m.name] = 0);
            snap.forEach(ds => {
                const d = ds.data(); total += d.amount;
                // åˆ†å¸³é‚è¼¯... (ç¶­æŒåŸæ¨£)
                if(balances.hasOwnProperty(d.payer)) balances[d.payer] += d.amount;
                const per = d.amount / d.splitTo.length;
                d.splitTo.forEach(m => { if(balances.hasOwnProperty(m)) balances[m] -= per; });

                const sym = d.currency === 'JPY' ? 'Â¥' : '$';
                detailHtml += `
                    <div class="expense-detail-item" onclick="window.openPayment('${ds.id}')" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                        <div><b>${d.name}</b><br><small style="color:#888;">${d.payer} å¢Šä»˜ (${sym}${d.rawAmount})</small></div>
                        <div style="text-align:right;"><b>$${Math.round(d.amount).toLocaleString()}</b></div>
                    </div>`;
            });
            document.getElementById('total-val').innerText = "$" + Math.round(total).toLocaleString();
            document.getElementById('expense-detail-list').innerHTML = detailHtml;
            updateSettleUI(balances);
        });

        // --- ç™»æ©Ÿè­‰æ¸²æŸ“ï¼šWallet é¢¨æ ¼ ---
        onSnapshot(collection(db, "flights"), (snap) => {
            let html = '';
            snap.forEach(ds => {
                const f = ds.data();
                html += `
                    <div class="boarding-pass">
                        <div style="background:var(--accent); color:white; padding:10px 15px; display:flex; justify-content:space-between; font-size:11px;">
                            <span>${f.air} ${f.no}</span><span>${f.type=='go'?'å»ç¨‹':'å›ç¨‹'}</span>
                        </div>
                        <div style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
                            <div style="text-align:left;"><p style="font-size:24px; font-weight:900; margin:0; color:var(--accent);">${f.from}</p><b>${f.fromT}</b></div>
                            <div style="text-align:center; flex:1;"><i class="fas fa-plane" style="color:#eee; font-size:20px;"></i></div>
                            <div style="text-align:right;"><p style="font-size:24px; font-weight:900; margin:0; color:var(--accent);">${f.to}</p><b>${f.toT}</b></div>
                        </div>
                    </div>`;
            });
            document.getElementById('flight-display-area').innerHTML = html;
        });

        // --- æˆå“¡æ‘˜è¦æ¸²æŸ“ ---
        onSnapshot(doc(db, "settings", "currentTrip"), (snap) => {
            if(snap.exists()) {
                const d = snap.data();
                currentMembers = d.members || [];
                const summaryEl = document.getElementById('member-avatars-summary');
                summaryEl.innerHTML = currentMembers.map(m => `<img src="${m.avatar}" style="width:35px; height:35px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.1);">`).join('');
                // å…¶é¤˜æ›´æ–°...
            }
        });

        // å…¶é¤˜åŸæœ¬åŠŸèƒ½ (saveItinerary, deletePlan, saveExpense, switchTab, etc.) ç¶­æŒåŸæ¨£...
        // è¨˜å¾—æŠŠåŸæœ¬ä»£ç¢¼ä¸­çš„é€™äº›å‡½æ•¸è£œå›å»å³å¯é‹ä½œã€‚
        
        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        };
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        // ...ä»¥æ­¤é¡æ¨
    </script>
</body>
</html>
