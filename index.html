<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Planner</title>
    <style>
        :root {
            --bg-color: #f6f8fa;
            --accent-color: #007AFF;
            --text-main: #1c1c1e;
            --text-sub: #8e8e93;
            --card-bg: #ffffff;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            margin: 0; 
            padding: 20px 20px 100px 20px; 
        }
        .app-header { margin: 20px 0; display: flex; justify-content: space-between; align-items: flex-end; }
        .app-header h1 { margin: 0; font-size: 28px; font-weight: 800; }
        .total-badge { background: var(--accent-color); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .input-section { background: var(--card-bg); padding: 15px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .input-section input { width: 100%; border: none; padding: 10px 0; margin-bottom: 8px; border-bottom: 1px solid #eee; font-size: 15px; outline: none; box-sizing: border-box; }
        .add-btn { background: var(--accent-color); color: white; width: 100%; border: none; padding: 12px; border-radius: 12px; font-weight: 600; margin-top: 10px; cursor: pointer; }
        .date-title { font-size: 14px; color: var(--text-sub); font-weight: 600; margin: 20px 0 10px 5px; }
        .trip-card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; }
        .card-left { flex: 1; }
        .card-time { color: var(--accent-color); font-size: 13px; font-weight: 700; margin-bottom: 4px; }
        .card-activity { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
        .card-note { color: var(--text-sub); font-size: 13px; margin-bottom: 5px; }
        .card-right { text-align: right; margin-left: 10px; }
        .card-cost { font-weight: 700; color: #ff3b30; margin-bottom: 8px; }
        .file-link { color: var(--accent-color); text-decoration: none; font-size: 12px; background: #eef6ff; padding: 4px 8px; border-radius: 6px; display: inline-block; }
        .btn-del { color: #ccc; border: none; background: none; font-size: 18px; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>

<div class="app-header">
    <div>
        <small style="color:var(--text-sub)">æˆ‘çš„æ—…è¡Œ</small>
        <h1>è¡Œç¨‹è¦åŠƒ</h1>
    </div>
    <div class="total-badge" id="total-sum">$0</div>
</div>

<div class="input-section">
    <input type="date" id="date">
    <input type="text" id="time" placeholder="æ™‚é–“ (ä¾‹ 10:30)">
    <input type="text" id="activity" placeholder="è¦å»å“ªè£¡ï¼Ÿ">
    <input type="text" id="note" placeholder="å‚™è¨» (é£¯åº—ã€ç¥¨åˆ¸ç·¨è™Ÿ)">
    <input type="number" id="cost" placeholder="èŠ±è²»é‡‘é¡">
    <input type="text" id="fileUrl" placeholder="æª”æ¡ˆé€£çµ (Google Drive)">
    <button class="add-btn" onclick="saveData()">ç¢ºèªæ–°å¢</button>
</div>

<div id="trip-list">è®€å–ä¸­...</div>

<script type="module">
    // å¼•å…¥ Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ä½ çš„ Firebase è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyCcXPvCma5TilSjZfAGYJg8n8ZfAAsqNtE",
        authDomain: "my-travel-app-b029c.firebaseapp.com",
        projectId: "my-travel-app-b029c",
        storageBucket: "my-travel-app-b029c.firebasestorage.app",
        messagingSenderId: "898590101576",
        appId: "1:898590101576:web:7c1916bb7ebbada144487d"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // å„²å­˜è³‡æ–™åˆ° Firebase
    window.saveData = async () => {
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        const activity = document.getElementById('activity').value;
        const note = document.getElementById('note').value;
        const cost = document.getElementById('cost').value || 0;
        const fileUrl = document.getElementById('fileUrl').value;

        if(date && activity) {
            try {
                await addDoc(collection(db, "trips"), {
                    date, time, activity, note, 
                    cost: parseFloat(cost), 
                    fileUrl, 
                    createdAt: new Date()
                });
                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.getElementById('time').value = '';
                document.getElementById('activity').value = '';
                document.getElementById('note').value = '';
                document.getElementById('cost').value = '';
                document.getElementById('fileUrl').value = '';
                alert("å„²å­˜æˆåŠŸï¼");
            } catch (e) {
                console.error("éŒ¯èª¤: ", e);
                alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase Rules è¨­å®šã€‚");
            }
        } else {
            alert("è«‹å‹™å¿…å¡«å¯«æ—¥æœŸèˆ‡åœ°é»ï¼");
        }
    };

    // åˆªé™¤è¡Œç¨‹
    window.deleteItem = async (id) => {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¡Œç¨‹å—ï¼Ÿ")) {
            await deleteDoc(doc(db, "trips", id));
        }
    };

    // å³æ™‚ç›£è½è³‡æ–™åº«
    const q = query(collection(db, "trips"), orderBy("date", "asc"), orderBy("time", "asc"));
    onSnapshot(q, (snapshot) => {
        let html = '';
        let total = 0;
        let lastDate = "";

        if (snapshot.empty) {
            document.getElementById('trip-list').innerHTML = '<p style="text-align:center; color:#8e8e93;">ç›®å‰å°šç„¡è¡Œç¨‹ï¼Œè«‹å¾ä¸Šæ–¹æ–°å¢ã€‚</p>';
            document.getElementById('total-sum').innerText = '$0';
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.date !== lastDate) {
                html += `<div class="date-title">ğŸ—“ï¸ ${data.date}</div>`;
                lastDate = data.date;
            }

            const costText = data.cost > 0 ? `<div class="card-cost">$${data.cost}</div>` : '';
            const fileBtn = data.fileUrl ? `<a href="${data.fileUrl}" target="_blank" class="file-link">æŸ¥çœ‹é™„ä»¶</a>` : '';

            html += `
                <div class="trip-card">
