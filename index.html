<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qiao æ—…éŠèªŒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --glass: rgba(255, 255, 255, 0.88); --blur: blur(20px); --accent: #1e3c72; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 120px; background: url('https://static.gltjp.com/glt/data/article/21000/20246/20230828_043453_d11a1481_w1920.webp') no-repeat center center fixed; background-size: cover; min-height: 100vh; color: #333; }
        
        .tab-content { display: none; padding: 0 10px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); padding: 40px 20px 10px; }

        /* Boarding Pass Style */
        .boarding-pass { background: #fff; border-radius: 20px; margin: 15px 5px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .ticket-top { background: var(--accent); color: white; padding: 10px 15px; font-size: 11px; display: flex; justify-content: space-between; }
        .ticket-mid { padding: 20px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed #eee; position: relative; }
        .airport-code { font-size: 28px; font-weight: 800; color: var(--accent); margin: 0; }
        .ticket-btm { padding: 12px 15px; background: #fdfdfd; display: grid; grid-template-columns: repeat(3, 1fr); font-size: 11px; }

        /* Date Scroll Buttons */
        .date-container { display: flex; overflow-x: auto; padding: 15px 5px; gap: 12px; scrollbar-width: none; }
        .date-item { min-width: 65px; height: 80px; background: var(--glass); border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.4); flex-shrink: 0; }
        .date-item.active { background: var(--accent); color: white; }
        .date-item b { font-size: 17px; }
        .date-item span { font-size: 11px; margin-top: 2px; }

        /* Itinerary Card */
        .itinerary-card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 22px; margin: 10px 0; padding: 18px; display: flex; justify-content: space-between; align-items: center; }
        .trip-info b { font-size: 18px; display: block; }
        .commute-tag { text-align: center; font-size: 12px; color: white; background: rgba(0,0,0,0.4); width: fit-content; margin: 5px auto; padding: 4px 12px; border-radius: 20px; }

        .card-actions { display: flex; flex-direction: column; gap: 8px; }
        .action-btn { padding: 8px 15px; border-radius: 10px; border: none; font-size: 12px; font-weight: bold; color: white; }
        .btn-edit { background: #3498db; }
        .btn-pay { background: #27ae60; }

        /* FAB & Modal */
        .fab { position: fixed; bottom: 100px; right: 25px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; z-index: 900; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; max-width: 400px; border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; }
        .modal-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; margin-top: 10px; }

        .nav-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); height: 75px; border-radius: 38px; display: flex; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; text-decoration: none; font-size: 11px; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <div class="header"><h1 id="dynamic-trip-name">æ—…éŠèªŒ</h1></div>

    <div id="tab-home" class="tab-content active">
        <div id="flight-display-area"></div>
        
        <div class="card" style="background:var(--glass); border-radius:24px; padding:20px; margin:15px 5px;">
            <strong style="font-size:18px;">æ—…ç¨‹åŸºç¤è¨­å®š</strong>
            <input type="text" id="input-trip-name" placeholder="æ—…è¡Œåç¨±">
            <input type="text" id="input-members" placeholder="æˆå“¡ (ç”¨é€—è™Ÿéš”é–‹)">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><small>é–‹å§‹æ—¥æœŸ</small><input type="date" id="input-start-date"></div>
                <div style="flex:1;"><small>çµæŸæ—¥æœŸ</small><input type="date" id="input-end-date"></div>
            </div>
            <button class="modal-btn" style="background:var(--accent); color:white;" onclick="saveBaseSettings()">å„²å­˜æ—…ç¨‹</button>
        </div>
        
        <div class="fab" onclick="openModal('modal-flight')"><i class="fas fa-plane"></i></div>
    </div>

    <div id="tab-plan" class="tab-content">
        <h3 style="color:white; text-align:center;">æ¯æ—¥è¡Œç¨‹</h3>
        <div class="date-container" id="date-scroll"></div>
        <div id="weather-box" style="text-align:center; color:white; margin-bottom:15px;"></div>
        <div id="itinerary-list"></div>
        <div class="fab" onclick="openModal('modal-itinerary')"><i class="fas fa-plus"></i></div>
    </div>

    <div id="modal-flight" class="modal-overlay">
        <div class="modal-content">
            <h3>âœˆï¸ æ–°å¢èˆªç­è³‡è¨Š</h3>
            <select id="f-type"><option value="go">å»ç¨‹èˆªç­</option><option value="back">å›ç¨‹èˆªç­</option></select>
            <input type="text" id="f-air" placeholder="èˆªç©ºå…¬å¸"><input type="text" id="f-no" placeholder="èˆªç­è™Ÿç¢¼">
            <div style="display:flex; gap:10px;"><input type="text" id="f-from" placeholder="èµ·é£› (TPE)"><input type="time" id="f-from-t"></div>
            <div style="display:flex; gap:10px;"><input type="text" id="f-to" placeholder="æŠµé” (NRT)"><input type="time" id="f-to-t"></div>
            <button class="modal-btn" style="background:var(--accent); color:white;" onclick="saveFlight()">å„²å­˜ç™»æ©Ÿè­‰</button>
            <button class="modal-btn" style="background:#f5f5f5;" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="modal-itinerary" class="modal-overlay">
        <div class="modal-content">
            <h3>ğŸ“ ç·¨è¼¯è¡Œç¨‹è¨ˆç•«</h3>
            <input type="hidden" id="edit-id">
            <div style="display:flex; gap:10px;"><input type="time" id="plan-start"><input type="time" id="plan-end"></div>
            <input type="text" id="plan-location" placeholder="åœ°é»åç¨±">
            <button class="modal-btn" style="background:var(--accent); color:white;" onclick="saveItinerary()">å„²å­˜è¡Œç¨‹</button>
            <button class="modal-btn" style="background:#f5f5f5;" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="modal-payment" class="modal-overlay">
        <div class="modal-content">
            <h3>ğŸ’° è¨˜å¸³åˆ†æ”¤</h3>
            <input type="hidden" id="pay-trip-id"><input type="number" id="pay-amount" placeholder="é‡‘é¡">
            <select id="pay-payer"></select>
            <div id="pay-split-list" style="margin-top:10px;"></div>
            <button class="modal-btn" style="background:#27ae60; color:white;" onclick="saveExpense()">ç¢ºèªè¨˜å¸³</button>
            <button class="modal-btn" style="background:#f5f5f5;" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="tab-files" class="tab-content"></div>
    <div id="tab-split" class="tab-content"></div>

    <div class="nav-bar">
        <a href="javascript:void(0)" class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home"></i><span>é¦–é </span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-plan', this)"><i class="fas fa-calendar-alt"></i><span>è¡Œç¨‹</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-files', this)"><i class="fas fa-paperclip"></i><span>é™„ä»¶</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-split', this)"><i class="fas fa-coins"></i><span>åˆ†å¸³</span></a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, updateDoc, deleteDoc, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcXPvCma5TilSjZfAGYJg8n8ZfAAsqNtE",
            authDomain: "my-travel-app-b029c.firebaseapp.com",
            projectId: "my-travel-app-b029c",
            storageBucket: "my-travel-app-b029c.appspot.com",
            messagingSenderId: "898590101576",
            appId: "1:898590101576:web:7c1916bb7ebbada144487d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentMembers = [];
        let selectedDate = "";
        let tripRange = { start: "", end: "" };

        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        };

        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');

        // é¦–é è¨­å®šèˆ‡æ—¥æœŸå€é–“è¨ˆç®—
        window.saveBaseSettings = async () => {
            const name = document.getElementById('input-trip-name').value;
            const members = document.getElementById('input-members').value.split(',').map(m => m.trim());
            const start = document.getElementById('input-start-date').value;
            const end = document.getElementById('input-end-date').value;
            await setDoc(doc(db, "settings", "currentTrip"), { tripName: name, members, start, end });
            alert("è¨­å®šå·²å„²å­˜");
        };

        onSnapshot(doc(db, "settings", "currentTrip"), (snap) => {
            if (snap.exists()) {
                const d = snap.data();
                document.getElementById('dynamic-trip-name').innerText = d.tripName || "æ—…éŠèªŒ";
                document.getElementById('input-trip-name').value = d.tripName || "";
                document.getElementById('input-members').value = (d.members || []).join(", ");
                document.getElementById('input-start-date').value = d.start || "";
                document.getElementById('input-end-date').value = d.end || "";
                currentMembers = d.members || [];
                tripRange = { start: d.start, end: d.end };
                renderDateScroll();
            }
        });

        function renderDateScroll() {
            if (!tripRange.start || !tripRange.end) return;
            let html = '';
            let current = new Date(tripRange.start);
            const stop = new Date(tripRange.end);
            
            while (current <= stop) {
                const dStr = current.toISOString().split('T')[0];
                const mmdd = (current.getMonth() + 1) + '/' + current.getDate();
                const dayStr = current.toLocaleDateString('zh-TW', { weekday: 'short' });
                html += `<div class="date-item ${selectedDate == dStr ? 'active' : ''}" onclick="selectDate('${dStr}')"><b>${mmdd}</b><span>${dayStr}</span></div>`;
                current.setDate(current.getDate() + 1);
            }
            document.getElementById('date-scroll').innerHTML = html;
            if (!selectedDate) selectDate(tripRange.start);
        }

        window.selectDate = (d) => {
            selectedDate = d;
            renderDateScroll();
            renderItineraryList();
        };

        // èˆªç­èˆ‡è¡Œç¨‹åˆ—è¡¨ (é‚è¼¯èˆ‡å‰ç‰ˆä¸€è‡´ï¼Œç¢ºä¿ ID æ­£ç¢º)
        onSnapshot(collection(db, "flights"), (snap) => {
            let html = '';
            snap.forEach(d => {
                const f = d.data();
                html += `<div class="boarding-pass"><div class="ticket-top"><span>${f.air}</span><span>${f.type=='go'?'å»ç¨‹':'å›ç¨‹'}</span></div><div class="ticket-mid"><div style="text-align:left;"><p class="airport-code">${f.from}</p><span>${f.fromT}</span></div><i class="fas fa-plane" style="color:#eee; font-size:24px;"></i><div style="text-align:right;"><p class="airport-code">${f.to}</p><span>${f.toT}</span></div></div><div class="ticket-btm"><div>èˆªç­<br><b>${f.no}</b></div><div>GATE<br><b>TBA</b></div><div>SEAT<br><b>ANY</b></div></div></div>`;
            });
            document.getElementById('flight-display-area').innerHTML = html;
        });

        // è¡Œç¨‹èˆ‡åˆ†æ”¤é‚è¼¯... (ç•¥ï¼Œç¶­æŒå‰ç‰ˆæœ¬ä¹‹æ­£ç¢ºå¯¦ä½œ)
        window.saveItinerary = async () => {
            const data = { date: selectedDate, start: document.getElementById('plan-start').value, end: document.getElementById('plan-end').value, location: document.getElementById('plan-location').value };
            await addDoc(collection(db, "itinerary"), data);
            closeModal();
        };

        async function renderItineraryList() {
            const qItin = query(collection(db, "itinerary"), where("date", "==", selectedDate), orderBy("start", "asc"));
            const snap = await getDocs(qItin);
            let html = '';
            snap.docs.forEach((d, i) => {
                const item = d.data();
                html += `<div class="itinerary-card"><div class="trip-info"><span>${item.start} - ${item.end}</span><b>${item.location}</b></div><div class="card-actions"><button class="action-btn btn-edit">ç·¨è¼¯</button><button class="action-btn btn-pay">è¨˜å¸³</button></div></div>`;
                if (i < snap.docs.length - 1) html += `<div class="commute-tag"><i class="fas fa-car"></i> ç´„ 15 åˆ†é˜</div>`;
            });
            document.getElementById('itinerary-list').innerHTML = html || '<p style="text-align:center; color:white; opacity:0.6;">æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>';
        }
    </script>
</body>
</html>
