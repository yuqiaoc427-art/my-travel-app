<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qiao ÊóÖÈÅäË™å - GPS ÂÆö‰ΩçÁâà</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --glass: rgba(255, 255, 255, 0.92); --blur: blur(20px); --accent: #1e3c72; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 120px; background: url('https://static.gltjp.com/glt/data/article/21000/20246/20230828_043453_d11a1481_w1920.webp') no-repeat center center fixed; background-size: cover; min-height: 100vh; color: #333; overflow-x: hidden; }
        
        .tab-content { display: none; padding: 0 10px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); padding: 40px 20px 10px; }
        #weather-box { background: rgba(0,0,0,0.4); color: white; border-radius: 15px; padding: 10px; margin: 10px auto; width: fit-content; display: flex; align-items: center; gap: 8px; font-size: 14px; backdrop-filter: blur(5px); min-height: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        /* Boarding Pass */
        .boarding-pass { background: #fff; border-radius: 20px; margin: 15px 5px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-left: 8px solid var(--accent); }
        .ticket-top { background: var(--accent); color: white; padding: 10px 15px; display: flex; justify-content: space-between; font-size: 11px; font-weight: bold; }
        .ticket-mid { padding: 25px 20px; display: flex; justify-content: space-between; align-items: center; }
        .airport-code { font-size: 32px; font-weight: 900; color: var(--accent); margin: 0; }
        .ticket-btm { padding: 15px 20px; background: #fafafa; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; border-top: 2px dashed #eee; }

        /* Êó•ÊúüÊç≤Ëª∏ */
        .date-container { display: flex; overflow-x: auto; padding: 15px 5px; gap: 12px; scrollbar-width: none; }
        .date-item { min-width: 65px; height: 85px; background: var(--glass); border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); flex-shrink: 0; }
        .date-item.active { background: var(--accent); color: white; border: none; box-shadow: 0 5px 15px rgba(30,60,114,0.3); }

        /* Ë°åÁ®ãÂç°Áâá */
        .itinerary-card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 22px; margin: 10px 0; padding: 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .btn-action { padding: 8px 15px; border-radius: 10px; border: none; font-size: 12px; font-weight: bold; color: white; cursor: pointer; width: 80px; margin-bottom: 5px; }
        .commute-info { text-align: center; color: white; font-size: 12px; margin: 5px 0; font-weight: 500; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

        /* Â∞éË¶ΩËàáÂΩàÁ™ó */
        .fab { position: fixed; bottom: 110px; right: 25px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 900; border: none; }
        .nav-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); height: 75px; border-radius: 38px; display: flex; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #bbb; text-decoration: none; font-size: 11px; }
        .nav-item.active { color: var(--accent); font-weight: bold; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #eee; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        .pac-container { z-index: 3000 !important; border-radius: 12px; }
        .preview-img { width: 100%; border-radius: 15px; margin-top: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div class="header"><h1 id="dynamic-trip-name">ÊóÖÈÅäË™å</h1></div>

    <div id="tab-home" class="tab-content active">
        <div id="flight-display-area"></div>
        <div class="card" style="background:var(--glass); border-radius:24px; padding:20px; margin:15px 5px;">
            <strong>‚öôÔ∏è ÊóÖÁ®ãË®≠ÂÆö</strong>
            <input type="text" id="input-trip-name" placeholder="ÊóÖË°åÂêçÁ®±">
            <input type="text" id="input-members" placeholder="ÊàêÂì° (Áî®ÈÄóËôüÈöîÈñã)">
            <div style="display:flex; gap:10px;"><input type="date" id="input-start-date"><input type="date" id="input-end-date"></div>
            <button onclick="saveBaseSettings()" style="width:100%; padding:14px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:bold;">ÂÑ≤Â≠ò</button>
        </div>
        <button class="fab" onclick="openModal('modal-flight')"><i class="fas fa-plane"></i></button>
    </div>

    <div id="tab-plan" class="tab-content">
        <div id="weather-box"><i class="fas fa-location-arrow fa-spin"></i> Ê≠£Âú®ÂÆö‰ΩçÊÇ®ÁöÑ‰ΩçÁΩÆ...</div>
        <div class="date-container" id="date-scroll"></div>
        <div id="itinerary-list"></div>
        <button class="fab" onclick="openModal('modal-itinerary')"><i class="fas fa-plus"></i></button>
    </div>

    <div id="tab-files" class="tab-content"><div id="link-list"></div></div>
    <div id="tab-split" class="tab-content"><div class="card" id="personal-list" style="background:white; border-radius:24px; padding:20px; margin:15px;"></div></div>

    <div id="modal-itinerary" class="modal-overlay"><div class="modal-content">
        <h3>üìù Á∑®ËºØË°åÁ®ã</h3>
        <input type="hidden" id="edit-id">
        <input type="text" id="plan-location" placeholder="Âú∞ÈªûÈóúÈçµÂ≠ó">
        <div style="display:flex; gap:10px;"><input type="time" id="plan-start"><input type="time" id="plan-end"></div>
        <button onclick="saveItinerary()" style="width:100%; background:var(--accent); color:white; padding:12px; border:none; border-radius:12px;">ÂÑ≤Â≠òË°åÁ®ã</button>
        <button onclick="closeModal()" style="width:100%; background:#eee; margin-top:10px; border:none; padding:10px; border-radius:12px;">ÂèñÊ∂à</button>
    </div></div>

    <div class="nav-bar">
        <a href="javascript:void(0)" class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home"></i><span>È¶ñÈ†Å</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-plan', this)"><i class="fas fa-calendar-alt"></i><span>Ë°åÁ®ã</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-files', this)"><i class="fas fa-paperclip"></i><span>ÈôÑ‰ª∂</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-split', this)"><i class="fas fa-coins"></i><span>ÂàÜÂ∏≥</span></a>
    </div>

    <script>
        // Google Maps ÂàùÂßãÂåñ
        window.initAutocomplete = function() {
            const input = document.getElementById('plan-location');
            if(!input) return;
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.name) input.value = place.name;
            });
        };
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZOejBZ46GgLgG8sFbVtuYp6fcqUn44w4&libraries=places&callback=initAutocomplete" async defer></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, updateDoc, getDoc, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCcXPvCma5TilSjZfAGYJg8n8ZfAAsqNtE", authDomain: "my-travel-app-b029c.firebaseapp.com", projectId: "my-travel-app-b029c", storageBucket: "my-travel-app-b029c.appspot.com", messagingSenderId: "898590101576", appId: "1:898590101576:web:7c1916bb7ebbada144487d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const WEATHER_KEY = "c8f4d0fbf6c2b1cded4335d40c62d3f5";
        let currentMembers = [], selectedDate = "";

        // --- Ê†∏ÂøÉÊõ¥Êñ∞ÔºöGPS ÂÆö‰ΩçÂ§©Ê∞£ ---
        async function getGPSWeather() {
            const weatherBox = document.getElementById('weather-box');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    try {
                        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_KEY}&units=metric&lang=zh_tw`);
                        const data = await res.json();
                        if(data.cod === 200) {
                            weatherBox.innerHTML = `
                                <i class="fas fa-map-marker-alt"></i> <b>${data.name}</b>
                                <img src="https://openweathermap.org/img/wn/${data.weather[0].icon}.png" width="30">
                                <span>${Math.round(data.main.temp)}¬∞C</span>
                                <small>(È´îÊÑü ${Math.round(data.main.feels_like)}¬∞C)</small>`;
                        }
                    } catch (e) { weatherBox.innerText = "ÁÑ°Ê≥ïËÆÄÂèñÂ§©Ê∞£Êï∏Êìö"; }
                }, () => {
                    weatherBox.innerText = "ÂÆö‰ΩçÊ¨äÈôêÈÅ≠ÊãíÔºåË´ãÈñãÂïü GPS";
                });
            } else { weatherBox.innerText = "ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÆö‰Ωç"; }
        }

        // È†ÅÈù¢Âä†ËºâÊôÇÂü∑Ë°åÂÆö‰Ωç
        window.addEventListener('load', getGPSWeather);

        // --- Ë°åÁ®ãÂäüËÉΩ (‰øÆÊ≠£ÂÖ®ÂüüÂáΩÊï∏ÂëºÂè´) ---
        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'tab-plan') getGPSWeather(); // ÂàáÊèõÂõûË°åÁ®ãÊôÇÂà∑Êñ∞Â§©Ê∞£
        };

        window.saveItinerary = async () => {
            const data = { date: selectedDate, location: document.getElementById('plan-location').value, start: document.getElementById('plan-start').value, end: document.getElementById('plan-end').value, updatedAt: new Date() };
            await addDoc(collection(db, "itinerary"), data);
            closeModal(); refreshItinerary();
        };

        async function refreshItinerary() {
            if(!selectedDate) return;
            const q = query(collection(db, "itinerary"), where("date", "==", selectedDate), orderBy("start", "asc"));
            const snap = await getDocs(q);
            let html = '', docs = snap.docs;
            for(let i=0; i<docs.length; i++) {
                const d = docs[i].data(), id = docs[i].id;
                html += `<div class="itinerary-card"><div style="flex:1;"><small>${d.start} - ${d.end}</small><br><b>${d.location}</b></div>
                    <div style="display:flex; flex-direction:column;">
                        <button class="btn-action" style="background:#3498db" onclick="window.editPlan('${id}')">Á∑®ËºØ</button>
                        <button class="btn-action" style="background:#27ae60" onclick="window.openPayment('${id}')">Ë®òÂ∏≥</button>
                    </div></div>`;
                if(i < docs.length - 1) {
                    const time = await getGoogleCommute(d.location, docs[i+1].data().location);
                    html += `<div class="commute-info"><i class="fas fa-car"></i> ËªäÁ®ãÈ†êË®à ${time}</div>`;
                }
            }
            document.getElementById('itinerary-list').innerHTML = html || '<p style="text-align:center; color:white;">ÁÑ°Ë°åÁ®ã</p>';
        }

        async function getGoogleCommute(origin, dest) {
            return new Promise((resolve) => {
                const service = new google.maps.DistanceMatrixService();
                service.getDistanceMatrix({ origins: [origin], destinations: [dest], travelMode: 'DRIVING' }, (res, status) => {
                    if (status === 'OK' && res.rows[0].elements[0].status === 'OK') resolve(res.rows[0].elements[0].duration.text);
                    else resolve("...");
                });
            });
        }

        // --- ‰ª•‰∏ãÁÇ∫ÂéüÊú¨Á©©ÂÆöÁöÑÈ¶ñÈ†ÅËàáÂÖ∂‰ªñÈÇèËºØ ---
        window.saveBaseSettings = async () => {
            const data = { tripName: document.getElementById('input-trip-name').value, members: document.getElementById('input-members').value.split(','), start: document.getElementById('input-start-date').value, end: document.getElementById('input-end-date').value };
            await setDoc(doc(db, "settings", "currentTrip"), data);
            alert("Ë®≠ÂÆöÂÑ≤Â≠òÊàêÂäü");
        };

        onSnapshot(doc(db, "settings", "currentTrip"), (snap) => {
            if (snap.exists()) {
                const d = snap.data();
                document.getElementById('dynamic-trip-name').innerText = d.tripName;
                renderDateButtons(d.start, d.end);
            }
        });

        function renderDateButtons(start, end) {
            if(!start || !end) return;
            let html = '', curr = new Date(start), last = new Date(end);
            while(curr <= last) {
                const dStr = curr.toISOString().split('T')[0];
                html += `<div class="date-item ${selectedDate==dStr?'active':''}" onclick="window.selectDate('${dStr}')"><b>${(curr.getMonth()+1)}/${curr.getDate()}</b></div>`;
                curr.setDate(curr.getDate() + 1);
            }
            document.getElementById('date-scroll').innerHTML = html;
            if(!selectedDate) window.selectDate(start);
        }

        window.selectDate = (d) => {
            selectedDate = d;
            document.querySelectorAll('.date-item').forEach(el => {
                const b = el.querySelector('b').innerText;
                const dObj = new Date(d);
                el.classList.toggle('active', b == ((dObj.getMonth()+1)+'/'+dObj.getDate()));
            });
            refreshItinerary();
        };

        // Ë£úÈΩäÂÖ®ÂüüÂºïÁî®
        window.editPlan = async (id) => {
            const ds = await getDoc(doc(db, "itinerary", id));
            const d = ds.data();
            document.getElementById('edit-id').value = id;
            document.getElementById('plan-location').value = d.location;
            document.getElementById('plan-start').value = d.start;
            document.getElementById('plan-end').value = d.end;
            openModal('modal-itinerary');
        };
    </script>
</body>
</html>
