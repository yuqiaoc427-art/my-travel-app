<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qiao æ—…éŠèªŒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root { --glass: rgba(255, 255, 255, 0.95); --blur: blur(20px); --accent: #1e3c72; --danger: #e74c3c; --success: #27ae60; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 100px; background: url('https://static.gltjp.com/glt/data/article/21000/20246/20230828_043453_d11a1481_w1920.webp') no-repeat center center fixed; background-size: cover; min-height: 100vh; color: #333; overflow-x: hidden; }
        
        .tab-content { display: none; padding: 0 10px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { text-align: center; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); padding: 40px 20px 10px; }
        #weather-box { background: rgba(0,0,0,0.4); color: white; border-radius: 20px; padding: 8px 15px; margin: 10px auto; width: fit-content; display: flex; align-items: center; gap: 8px; font-size: 13px; backdrop-filter: blur(10px); }

        /* --- ç™»æ©Ÿè­‰ UI å„ªåŒ– (Apple Wallet Style) --- */
        .boarding-pass { background: white; border-radius: 20px; margin: 15px 5px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: visible; }
        .boarding-pass::before, .boarding-pass::after { content: ''; position: absolute; width: 20px; height: 20px; background: rgba(0,0,0,0.3); border-radius: 50%; top: 45px; z-index: 2; }
        .boarding-pass::before { left: -10px; } .boarding-pass::after { right: -10px; }
        .ticket-top { background: var(--accent); color: white; padding: 12px 20px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; font-size: 11px; letter-spacing: 1px; }
        .ticket-mid { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed #eee; margin: 0 10px; }
        .airport-code { font-size: 32px; font-weight: 900; color: var(--accent); margin: 0; line-height: 1; }
        .ticket-btm { padding: 15px 20px; background: #fafafa; border-radius: 0 0 20px 20px; display: flex; justify-content: space-around; font-size: 10px; color: #666; }

        /* --- æ™‚é–“è»¸ UI å„ªåŒ– (Timeline Style) --- */
        #itinerary-list { position: relative; padding-left: 25px; margin-left: 15px; border-left: 2px dashed rgba(255,255,255,0.4); }
        .itinerary-card { background: var(--glass); border-radius: 20px; margin: 15px 0; padding: 16px; display: flex; align-items: center; box-shadow: 0 8px 20px rgba(0,0,0,0.1); position: relative; }
        .itinerary-card::before { content: ''; position: absolute; left: -33px; top: 25px; width: 14px; height: 14px; background: var(--accent); border: 3px solid white; border-radius: 50%; box-shadow: 0 0 10px rgba(30,60,114,0.5); z-index: 5; }
        .delete-btn-tl { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- æˆå“¡ç°¡åŒ–å±•ç¤º --- */
        .member-summary-bar { display: flex; align-items: center; gap: -10px; margin-bottom: 10px; padding: 5px; }
        .summary-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid white; margin-left: -10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .summary-avatar:first-child { margin-left: 0; }
        #members-list-container.collapsed { display: none; }

        /* å°è¦½èˆ‡é€šç”¨ */
        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 22px; margin: 10px 0; padding: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .nav-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.98); height: 55px; border-radius: 28px; display: flex; box-shadow: 0 8px 25px rgba(0,0,0,0.2); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; text-decoration: none; font-size: 10px; }
        .nav-item.active { color: var(--accent); font-weight: 900; }
        .fab { position: fixed; bottom: 85px; right: 25px; width: 55px; height: 55px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 900; border: none; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; }
        
        .expense-detail-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; cursor: pointer; }
        .type-icon { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--accent); font-size: 18px; margin-right: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .commute-info { font-size: 11px; color: white; margin: 5px 0 5px 45px; font-weight: bold; background: rgba(0,0,0,0.2); width: fit-content; padding: 2px 10px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="header"><h1 id="dynamic-trip-name">æ—…éŠèªŒ</h1></div>

    <div id="tab-home" class="tab-content active">
        <div id="flight-display-area"></div>
        <div class="card">
            <strong style="font-size:17px; display:block; margin-bottom:12px;">æ—…ç¨‹åŸºæœ¬è¨­å®š</strong>
            
            <span style="font-size:11px; color:#666;">æ—…è¡Œåç¨±</span>
            <input type="text" id="input-trip-name" placeholder="ä¾‹å¦‚ï¼š115 åŒ—æµ·é“ä¹‹æ—…">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin: 15px 0 5px;">
                <span style="font-size:11px; color:#666;">æ—…ä¼´æˆå“¡</span>
                <button onclick="toggleMemberEdit()" id="edit-member-btn" style="background:var(--accent); color:white; border:none; padding:4px 12px; border-radius:15px; font-size:11px;">ç·¨è¼¯æˆå“¡</button>
            </div>
            <div id="member-summary-display" class="member-summary-bar"></div>
            <div id="members-list-container" class="collapsed"></div>
            <button onclick="addMemberRow()" id="add-row-btn" style="width:100%; padding:8px; background:#f0f0f0; border:none; border-radius:10px; font-size:11px; margin-bottom:15px; display:none;">+ æ–°å¢æˆå“¡æ¬„ä½</button>

            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><span style="font-size:11px; color:#666;">é–‹å§‹æ—¥æœŸ</span><input type="date" id="input-start-date"></div>
                <div style="flex:1;"><span style="font-size:11px; color:#666;">çµæŸæ—¥æœŸ</span><input type="date" id="input-end-date"></div>
            </div>
            <button onclick="saveBaseSettings()" style="width:100%; padding:14px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:bold; margin-top:10px;">å„²å­˜è¨­å®š</button>
            <button onclick="openModal('modal-reset')" style="width:100%; padding:10px; background:none; color:var(--danger); border:1px solid var(--danger); border-radius:12px; font-weight:bold; margin-top:15px; font-size:11px;">é‡è¨­è³‡æ–™</button>
        </div>
        
        <div class="currency-card">
            <strong style="font-size:15px; display:block; margin-bottom:10px;">ğŸ’¹ åŒ¯ç‡æ›ç®— (å³æ™‚)</strong>
            <div style="display:flex; align-items:center; gap:10px;"><input type="number" id="input-jpy" placeholder="JPY" oninput="convertCurrency('JPY')"><i class="fas fa-exchange-alt" style="color:var(--accent)"></i><input type="number" id="input-twd" placeholder="TWD" oninput="convertCurrency('TWD')"></div>
            <div id="exchange-rate-info" style="font-size:10px; color:#999; text-align:right; margin-top:5px;">è¼‰å…¥ä¸­...</div>
        </div>
        <button class="fab" onclick="openModal('modal-flight')"><i class="fas fa-plane"></i></button>
    </div>

    <div id="tab-plan" class="tab-content">
        <div id="weather-box">æ­£åœ¨è«‹æ±‚å®šä½...</div>
        <div class="date-container" id="date-scroll"></div>
        <div id="itinerary-list"></div>
        <button class="fab" onclick="openModal('modal-itinerary')"><i class="fas fa-plus"></i></button>
    </div>

    <div id="tab-split" class="tab-content">
        <div id="settle-suggestions" class="settle-card">æ­£åœ¨è¨ˆç®—å‚µå‹™...</div>
        <div class="card" style="text-align:center;">
            <p style="margin:0; color:#666; font-size:13px;">æ—…ç¨‹ç¸½æ”¯å‡º</p>
            <h1 id="total-val" style="margin:5px 0;">$0</h1>
            <div id="personal-list"></div>
        </div>
        <div class="card">
            <strong>èŠ±è²»æ˜ç´°</strong>
            <div id="expense-detail-list" style="margin-top:10px;"></div>
        </div>
        <button class="fab" onclick="window.openPayment()"><i class="fas fa-coins"></i></button>
    </div>

    <div id="modal-payment" class="modal-overlay"><div class="modal-content">
        <h3 id="payment-modal-title">ğŸ’° æ”¯å‡ºè¨˜å¸³</h3>
        <input type="hidden" id="edit-expense-id">
        <input type="text" id="pay-name" placeholder="é …ç›®åç¨± (å¦‚: æ™šé¤)">
        <div style="display:flex; gap:10px;">
            <select id="pay-currency" style="flex:0.4;" onchange="updateConvertHint()"><option value="TWD">å°å¹£ ($)</option><option value="JPY">æ—¥åœ“ (Â¥)</option></select>
            <input type="number" id="pay-amount" placeholder="é‡‘é¡" style="flex:1;" oninput="updateConvertHint()">
        </div>
        <span id="convert-hint" style="font-size:11px; color:var(--accent); display:block; margin-bottom:10px;"></span>
        <select id="pay-payer"></select>
        <div id="pay-split-list" style="max-height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:10px;"></div>
        <textarea id="pay-note" rows="2" placeholder="å‚™è¨»..."></textarea>
        <input type="file" id="pay-file" accept="image/*" onchange="previewExpenseFile(this)">
        <div id="preview-wrapper" style="position:relative; margin-top:10px; display:none;">
            <button onclick="removeExpenseFile()" style="position:absolute; top:5px; right:5px; background:var(--danger); color:white; border:none; border-radius:50%; width:20px; height:20px;">âœ•</button>
            <img id="expense-img-preview" style="width:100%; border-radius:10px;">
        </div>
        <button onclick="saveExpense()" style="width:100%; background:var(--success); color:white; padding:12px; border:none; border-radius:12px; margin-top:15px; font-weight:bold;">å„²å­˜</button>
        <button id="del-expense-btn" onclick="deleteExpenseReal()" style="width:100%; background:none; color:var(--danger); padding:10px; border:none; margin-top:5px; display:none;">åˆªé™¤æ­¤ç­†</button>
        <button onclick="closeModal()" style="width:100%; background:#eee; margin-top:5px; border:none; padding:10px; border-radius:12px;">å–æ¶ˆ</button>
    </div></div>

    <div id="modal-itinerary" class="modal-overlay">...</div>
    <div id="modal-flight" class="modal-overlay">...</div>

    <div class="nav-bar">
        <a href="javascript:void(0)" class="nav-item active" onclick="switchTab('tab-home', this)"><i class="fas fa-home"></i><span>é¦–é </span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-plan', this)"><i class="fas fa-calendar-alt"></i><span>è¡Œç¨‹</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="switchTab('tab-split', this)"><i class="fas fa-coins"></i><span>åˆ†å¸³</span></a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, updateDoc, getDoc, getDocs, where, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCcXPvCma5TilSjZfAGYJg8n8ZfAAsqNtE", authDomain: "my-travel-app-b029c.firebaseapp.com", projectId: "my-travel-app-b029c", storageBucket: "my-travel-app-b029c.appspot.com", messagingSenderId: "898590101576", appId: "1:898590101576:web:7c1916bb7ebbada144487d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const WEATHER_KEY = "c8f4d0fbf6c2b1cded4335d40c62d3f5";
        let currentMembers = [], selectedDate = "", exchangeRate = 0.22;

        const AVATAR_OPTIONS = [
            { name: 'åŒ—ç‹', url: 'https://images.unsplash.com/photo-1516934024742-b461fba4760a?w=100&h=100&fit=crop' },
            { name: 'è¦å¤·å°é£›é¼ ', url: 'https://images.unsplash.com/photo-1507356102280-305608778f8c?w=100&h=100&fit=crop' },
            { name: 'è¦å¤·é³´å…”', url: 'https://images.unsplash.com/photo-1585110396000-c9ffd4e4b308?w=100&h=100&fit=crop' },
            { name: 'è¦å¤·é¹¿', url: 'https://images.unsplash.com/photo-1484406566174-9da000fda645?w=100&h=100&fit=crop' },
            { name: 'ä¸¹é ‚é¶´', url: 'https://images.unsplash.com/photo-1612140417641-7a71f0217983?w=100&h=100&fit=crop' },
            { name: 'æ£•ç†Š', url: 'https://images.unsplash.com/photo-1530595467537-0b5996c41f2d?w=100&h=100&fit=crop' },
            { name: 'éŠ€å–‰é•·å°¾å±±é›€', url: 'https://images.unsplash.com/photo-1552728089-57bdde30eba3?w=100&h=100&fit=crop' },
            { name: 'è™é ­æµ·éµ°', url: 'https://images.unsplash.com/photo-1543444983-500742183c5e?w=100&h=100&fit=crop' }
        ];

        // --- æˆå“¡æ”¶åˆåŠŸèƒ½ ---
        window.toggleMemberEdit = () => {
            const container = document.getElementById('members-list-container');
            const summary = document.getElementById('member-summary-display');
            const addBtn = document.getElementById('add-row-btn');
            const editBtn = document.getElementById('edit-member-btn');
            
            if(container.classList.contains('collapsed')) {
                container.classList.remove('collapsed');
                summary.style.display = 'none';
                addBtn.style.display = 'block';
                editBtn.innerText = 'æ”¶åˆæ¸…å–®';
            } else {
                container.classList.add('collapsed');
                summary.style.display = 'flex';
                addBtn.style.display = 'none';
                editBtn.innerText = 'ç·¨è¼¯æˆå“¡';
            }
        };

        // --- å¹£åˆ¥èˆ‡åˆ†å¸³æ˜ç´°å„ªåŒ– ---
        onSnapshot(query(collection(db, "expenses"), orderBy("createdAt", "desc")), (snap) => {
            let total = 0, balances = {}, detailHtml = '';
            currentMembers.forEach(m => balances[m.name] = 0);
            snap.forEach(ds => {
                const d = ds.data(); total += d.amount;
                if(balances.hasOwnProperty(d.payer)) balances[d.payer] += d.amount;
                const per = d.amount / d.splitTo.length;
                d.splitTo.forEach(m => { if(balances.hasOwnProperty(m)) balances[m] -= per; });
                
                // å¹£åˆ¥ç¬¦è™Ÿåˆ¤å®š
                const symbol = d.currency === 'JPY' ? 'Â¥' : '$';
                detailHtml += `
                <div class="expense-detail-item" onclick="window.openPayment('${ds.id}')">
                    <div><b>${d.name}</b><br><small style="color:#888;">${d.payer} å¢Šä»˜ (${symbol}${d.rawAmount})</small></div>
                    <div style="text-align:right;"><b>$${Math.round(d.amount).toLocaleString()}</b>${d.img ? '<br><i class="fas fa-image" style="font-size:10px;color:#ccc;"></i>' : ''}</div>
                </div>`;
            });
            document.getElementById('total-val').innerText = "$" + Math.round(total).toLocaleString();
            document.getElementById('expense-detail-list').innerHTML = detailHtml;
            updateSettleUI(balances);
        });

        // --- è¡Œç¨‹èˆ‡æ™‚é–“è»¸æ¸²æŸ“ ---
        window.refreshItinerary = async () => {
            if(!selectedDate) return;
            const q = query(collection(db, "itinerary"), where("date", "==", selectedDate), orderBy("start", "asc"));
            const snap = await getDocs(q);
            const listEl = document.getElementById('itinerary-list');
            let html = '', docs = snap.docs;
            for(let i=0; i<docs.length; i++) {
                const d = docs[i].data(), id = docs[i].id;
                html += `
                    <div class="itinerary-card" data-id="${id}">
                        <div class="delete-btn-tl" onclick="window.deletePlan('${id}')">âœ•</div>
                        <div class="type-icon"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="info-col">
                            <div class="time-row">${d.start} - ${d.end} <span class="stay-tag">${d.start && d.end ? 'é è¨ˆåœç•™' : ''}</span></div>
                            <div class="location-text">${d.location}</div>
                            ${d.desc ? `<div style="font-size:12px;color:#666;margin-top:4px;">${d.desc}</div>` : ''}
                        </div>
                        <div class="btn-col">
                            <button class="btn-action" style="background:#f39c12; padding:5px; width:50px;" onclick="window.openOnGoogleMaps('${d.location}')"><i class="fas fa-directions"></i></button>
                            <button class="btn-action" style="background:#3498db; padding:5px; width:50px;" onclick="window.editPlan('${id}')">ç·¨è¼¯</button>
                        </div>
                    </div>`;
                if(i < docs.length - 1) {
                    const time = await getCommute(d.location, docs[i+1].data().location);
                    html += `<div class="commute-info"><i class="fas fa-car"></i> ${time}</div>`;
                }
            }
            listEl.innerHTML = html || '<p style="text-align:center; color:white; padding-top:20px;">å°šç„¡è¨ˆç•«</p>';
            new Sortable(listEl, { animation: 150 });
        };

        // --- ç™»æ©Ÿè­‰æ¸²æŸ“ ---
        onSnapshot(collection(db, "flights"), (snap) => {
            let html = '';
            snap.forEach(ds => {
                const f = ds.data();
                html += `
                <div class="boarding-pass">
                    <div class="ticket-top"><span>${f.air} ${f.no}</span><span>èˆªç©ºé€šè¡Œè­‰</span></div>
                    <div class="ticket-mid">
                        <div style="text-align:left;"><p class="airport-code">${f.from}</p><b>${f.fromT}</b></div>
                        <div style="flex:1; text-align:center; position:relative;"><i class="fas fa-plane" style="color:#eee; font-size:20px;"></i></div>
                        <div style="text-align:right;"><p class="airport-code">${f.to}</p><b>${f.toT}</b></div>
                    </div>
                    <div class="ticket-btm"><span>èˆªç­ï¼š${f.no}</span><span>é¡å‹ï¼š${f.type === 'go' ? 'å»ç¨‹' : 'å›ç¨‹'}</span></div>
                </div>`;
            });
            document.getElementById('flight-display-area').innerHTML = html;
        });

        // --- å…¶é¤˜ Firebase åŸºæœ¬åŠŸèƒ½å®Œå…¨ç¶­æŒ (addMemberRow, saveBaseSettings, saveItinerary, openPayment ç­‰) ---
        // (æ­¤è™•çœç•¥éƒ¨åˆ†é‡è¤‡é‚è¼¯ä»£ç¢¼ä»¥ç¯€çœç¯‡å¹…ï¼Œä½†é‹ä½œæ™‚éœ€åŒ…å«æ‚¨åŸæœ¬çš„å°æ‡‰å‡½æ•¸)
        
        // åˆå§‹åŒ–æˆå“¡æ‘˜è¦é ­åƒ
        onSnapshot(doc(db, "settings", "currentTrip"), (snap) => {
            if(snap.exists()) {
                const d = snap.data();
                currentMembers = d.members || [];
                const summaryEl = document.getElementById('member-summary-display');
                summaryEl.innerHTML = currentMembers.map(m => `<img src="${m.avatar}" class="summary-avatar" title="${m.name}">`).join('') + `<span style="font-size:12px; color:white; margin-left:15px;">${currentMembers.length} ä½æ—…ä¼´</span>`;
                
                const container = document.getElementById('members-list-container');
                container.innerHTML = '';
                currentMembers.forEach(m => window.addMemberRow(m.name, m.avatar));
                
                document.getElementById('dynamic-trip-name').innerText = d.tripName || "æ—…éŠèªŒ";
                renderDates(d.start, d.end);
            }
        });

        // é é¢èˆ‡ Modal åŸºæœ¬åŠŸèƒ½
        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        };
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        
        // (å…¶é¤˜å¦‚ getTimeDiff, getCommute, saveExpense ç­‰é‚è¼¯éœ€ä¿æŒèˆ‡æ‚¨çš„åŸå§‹ç‰ˆæœ¬ä¸€è‡´)
    </script>
</body>
</html>
